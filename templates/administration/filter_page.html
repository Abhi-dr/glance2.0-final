{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Advanced Filter Page{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_filter {
        float: none;
        text-align: left;
    }

    .dataTables_wrapper .dataTables_length {
        float: none;
        text-align: left;
    }

    .active-filters {
        margin: 10px 0;
    }

    .filter-badge {
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .dt-buttons {
        margin-bottom: 15px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
    }

    .export-section {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .export-section h5 {
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .export-button {
        margin-right: 5px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block body %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Advanced Filter Page</h3>
                </div>
                <div class="card-body">
                    <!-- Quick Attendance Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="fw-bold mb-3">Quick Attendance Filters</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="?attendance_status=present" class="btn btn-success">
                                    <i class="fas fa-check-circle me-1"></i> Present Students
                                </a>
                                <a href="?attendance_status=absent" class="btn btn-danger">
                                    <i class="fas fa-times-circle me-1"></i> Absent Students
                                </a>
                                <a href="?attendance_status=not_marked" class="btn btn-warning">
                                    <i class="fas fa-hourglass-half me-1"></i> Not Marked
                                </a>
                                <a href="?" class="btn btn-outline-secondary">
                                    <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="id" class="form-label">ID</label>
                                <input type="text" class="form-control" id="id" name="id" placeholder="Search by ID...">
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name"
                                    placeholder="Search by name...">
                            </div>
                            <div class="col-md-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email"
                                    placeholder="Search by email...">
                            </div>
                            <div class="col-md-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone" name="phone"
                                    placeholder="Search by phone...">
                            </div>
                            <div class="col-md-3">
                                <label for="course" class="form-label">Course</label>
                                <select class="form-select" id="course" name="course">
                                    <option value="">All Courses</option>
                                    <option value="B.Tech">B.Tech</option>
                                    <option value="BBA">BBA</option>
                                    <option value="BCA">BCA</option>
                                    <option value="MBA">MBA</option>
                                    <option value="MCA">MCA</option>
                                    <option value="M.Tech">M.Tech</option>
                                    <option value="B.Sc">B.Sc</option>
                                    <option value="M.Sc">M.Sc</option>
                                    <option value="B.Com">B.Com</option>
                                    <option value="M.Com">M.Com</option>
                                    <option value="B.A">B.A</option>
                                    <option value="M.A">M.A</option>
                                    <option value="Ph.D">Ph.D</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year">
                                    <option value="">All Years</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="cgpa" class="form-label">CGPA</label>
                                <div class="input-group">
                                    <select class="form-select" id="cgpa_operator" name="cgpa_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="cgpa" name="cgpa" placeholder="CGPA"
                                        step="0.01" min="0" max="10">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Status</option>
                                    <option value="Current Student">Current Student</option>
                                    <option value="Alumni">Alumni</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="companies_left" class="form-label">Companies Left</label>
                                <div class="input-group">
                                    <select class="form-select" id="companies_operator" name="companies_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="companies_left" name="companies_left"
                                        placeholder="Number" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="profile_score" class="form-label">Profile Score</label>
                                <div class="input-group">
                                    <select class="form-select" id="score_operator" name="score_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="profile_score" name="profile_score"
                                        placeholder="Score" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="company" class="form-label">Applied to Company</label>
                                <input type="text" class="form-control" id="company" name="company" 
                                    placeholder="Company name...">
                            </div>
                            <div class="col-md-3">
                                <label for="job" class="form-label">Applied to Job</label>
                                <input type="text" class="form-control" id="job" name="job"
                                    placeholder="Job title...">
                            </div>
                            <div class="col-md-3">
                                <label for="attendance_status" class="form-label">Attendance Status</label>
                                <select class="form-select" id="attendance_status" name="attendance_status">
                                    <option value="">All</option>
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="not_marked">Not Marked</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                                <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Filters -->
                    <div class="active-filters" id="activeFilters"></div>

                    <!-- Message to Filtered Students Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Send Message to Filtered Students</h5>
                        </div>
                        <div class="card-body">
                            <form id="messageForm" class="row g-3" action="{% url 'send_message_to_filtered_students' %}" method="POST">
                                {% csrf_token %}
                                <!-- Hidden fields to pass all current filter values -->
                                <input type="hidden" id="msg_id" name="id">
                                <input type="hidden" id="msg_name" name="name">
                                <input type="hidden" id="msg_email" name="email">
                                <input type="hidden" id="msg_phone" name="phone">
                                <input type="hidden" id="msg_course" name="course">
                                <input type="hidden" id="msg_year" name="year">
                                <input type="hidden" id="msg_cgpa" name="cgpa">
                                <input type="hidden" id="msg_cgpa_operator" name="cgpa_operator">
                                <input type="hidden" id="msg_status" name="status">
                                <input type="hidden" id="msg_companies_left" name="companies_left">
                                <input type="hidden" id="msg_companies_operator" name="companies_operator">
                                <input type="hidden" id="msg_profile_score" name="profile_score">
                                <input type="hidden" id="msg_score_operator" name="score_operator">
                                <input type="hidden" id="msg_company" name="company">
                                <input type="hidden" id="msg_job" name="job">
                                <input type="hidden" id="msg_attendance_status" name="attendance_status">
                                
                                <div class="col-md-12">
                                    <label for="messageSubject" class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="messageSubject" name="subject" placeholder="Message subject..." required>
                                </div>
                                <div class="col-md-12">
                                    <label for="messageContent" class="form-label">Message Content</label>
                                    <textarea class="form-control" id="messageContent" name="content" rows="4" placeholder="Type your message here..." required></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-info" id="sendMessageBtn">
                                        <i class="fas fa-paper-plane me-2"></i>Send Message
                                    </button>
                                    <div class="form-text mt-2">
                                        Message will be sent to all students matching your current filters as both email and notification.
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- DataTable -->
                    <div class="table-responsive mb-4">
                        <table id="dataTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>CGPA</th>
                                    <th>Status</th>
                                    <th>Companies Left</th>
                                    <th>Profile Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <!-- Export Section -->
                    <div class="card mb-4 export-section">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-file-export me-2"></i>Export Options</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">1. Export Filtered Data</h6>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <button id="filteredExportCSV" class="btn btn-outline-success export-button">
                                            <i class="fas fa-file-csv me-1"></i> CSV
                                        </button>
                                        <button id="filteredExportExcel" class="btn btn-outline-primary export-button">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button id="filteredExportHTML" class="btn btn-outline-info export-button">
                                            <i class="fas fa-file-code me-1"></i> HTML
                                        </button>
                                        <button id="filteredExportPDF" class="btn btn-outline-danger export-button">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">2. Export Student Documents</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button id="exportAllDocuments" class="btn btn-outline-primary export-button">
                                            <i class="fas fa-file-archive me-1"></i> All Documents
                                        </button>
                                        <button id="exportResumes" class="btn btn-outline-secondary export-button">
                                            <i class="fas fa-file-alt me-1"></i> Resumes Only
                                        </button>
                                        <button id="exportMarksheets" class="btn btn-outline-secondary export-button">
                                            <i class="fas fa-file-certificate me-1"></i> Marksheets Only
                                        </button>
                                        <button id="exportProfiles" class="btn btn-outline-secondary export-button">
                                            <i class="fas fa-id-card me-1"></i> Profile Pictures
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">3. Fallback Export Options</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        <a href="{% url 'export_filtered_students_pdf' %}" class="btn btn-outline-danger export-button" download>
                                            <i class="fas fa-file-pdf me-1"></i> Direct PDF Export
                                        </a>
                                        <a href="{% url 'export_all_students' %}?format=csv" class="btn btn-outline-success export-button" download>
                                            <i class="fas fa-download me-1"></i> All Students (CSV)
                                        </a>
                                    </div>
                                    <div class="form-text mt-2">
                                        Use these options if other export methods aren't working
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom export modal for additional options -->
<div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exportOptionsModalLabel">Export Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="mb-3">
                        <label class="form-label">Select Columns to Export</label>
                        <div id="columnCheckboxes" class="row">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="exportTitle" class="form-label">Export Title</label>
                        <input type="text" class="form-control" id="exportTitle" value="Filtered Students Data">
                    </div>
                    <div class="mb-3">
                        <label for="exportFilename" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="exportFilename" value="students_data">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="proceedExport">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Required JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Load DataTables Core and Extensions -->
<script type="text/javascript">
    // Check if jQuery loaded
    if (typeof jQuery === 'undefined') {
        document.write('<script src="{% static "js/dashboard/libs/jquery/dist/jquery.min.js" %}"><\/script>');
        console.warn('Local jQuery loaded as fallback');
    }
</script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

<!-- Export Buttons Libraries -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- ApexCharts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/4.5.0/apexcharts.min.js"></script>

<!-- Custom Dashboard JS -->
<script src="{% static 'js/dashboard/dashboard.js' %}"></script>

<script>
    // Wait for document ready with a safety timeout
    function initPage() {
        try {
            const loadingOverlay = $('#loadingOverlay');
            
            // Check if DataTable is available
            if (typeof $.fn.DataTable !== 'function') {
                console.error('DataTables library not properly loaded');
                // Try to load it again from a different source
                $.getScript("https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js")
                    .done(function() {
                        console.log("Successfully loaded DataTables from alternate source");
                        setTimeout(initializeDataTable, 500);
                    })
                    .fail(function() {
                        alert('Error: DataTables library could not be loaded. Please refresh the page or contact support.');
                    });
                return;
            }
            
            // Check if export libraries are loaded
            if (typeof JSZip !== 'function' || typeof pdfMake === 'undefined') {
                console.warn('Export libraries not fully loaded, attempting to load them...');
                // Try to load export libraries
                $.when(
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"),
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"),
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"),
                    $.getScript("https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"),
                    $.getScript("https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js")
                ).done(function() {
                    console.log("Successfully loaded export libraries");
                    setTimeout(initializeDataTable, 500);
                }).fail(function() {
                    console.error("Failed to load export libraries");
                    alert('Warning: Export functionality may be limited. Please try using the direct download links instead.');
                    initializeDataTable();
                });
            } else {
                initializeDataTable();
            }

            function initializeDataTable() {
                console.log("Initializing DataTable...");
                // Initialize DataTable with optimized settings
                const table = $('#dataTable').DataTable({
                    processing: true,
                    serverSide: true,
                    pageLength: 25,
                    deferRender: true,
                    searchDelay: 500,
                    ajax: {
                        url: '/accounts/api/datatables/students/',
                        type: 'GET',
                        data: function (d) {
                            // Add filter parameters
                            d.id = $('#id').val();
                            d.name = $('#name').val();
                            d.email = $('#email').val();
                            d.phone = $('#phone').val();
                            d.course = $('#course').val();
                            d.year = $('#year').val();
                            d.cgpa = $('#cgpa').val();
                            d.cgpa_operator = $('#cgpa_operator').val();
                            d.status = $('#status').val();
                            d.companies_left = $('#companies_left').val();
                            d.companies_operator = $('#companies_operator').val();
                            d.profile_score = $('#profile_score').val();
                            d.score_operator = $('#score_operator').val();
                            d.company = $('#company').val();
                            d.job = $('#job').val();
                            d.attendance_status = $('#attendance_status').val();
                            
                            // Debug logging
                            console.log("DataTable request parameters:", {
                                id: d.id,
                                name: d.name,
                                email: d.email,
                                companies_left: d.companies_left,
                                companies_operator: d.companies_operator,
                                company: d.company,
                                job: d.job,
                                attendance_status: d.attendance_status
                            });
                            return d;
                        },
                        beforeSend: function () {
                            loadingOverlay.css('display', 'flex');
                        },
                        complete: function () {
                            loadingOverlay.hide();
                        },
                        error: function (xhr, error, thrown) {
                            console.error('DataTables error:', error, thrown);
                            loadingOverlay.hide();
                            alert('Error loading data. Please try again.');
                        }
                    },
                    columns: [
                        { data: 'id' },
                        {
                            data: null,
                            render: function (data) {
                                return data.first_name + ' ' + data.last_name + 
                                // Add attendance icons
                                (data.attendance_status ? 
                                    (data.attendance_status === 'present' ? 
                                        ' <i class="fas fa-check-circle text-success" data-bs-toggle="tooltip" title="Present"></i>' : 
                                        (data.attendance_status === 'absent' ? 
                                            ' <i class="fas fa-times-circle text-danger" data-bs-toggle="tooltip" title="Absent"></i>' : 
                                            ' <i class="fas fa-question-circle text-secondary" data-bs-toggle="tooltip" title="Not Marked"></i>')) 
                                    : '');
                            }
                        },
                        { data: 'username' },
                        { data: 'phone_number' },
                        { data: 'course' },
                        { data: 'year' },
                        {
                            data: 'cgpa',
                            render: function (data) {
                                return data ? data.toFixed(2) : '-';
                            }
                        },
                        { data: 'alumni_status' },
                        { data: 'no_of_companies_left' },
                        {
                            data: 'profile_score',
                            render: function (data) {
                                return data + '%';
                            }
                        },
                        {
                            data: 'actions',
                            orderable: false,
                            searchable: false
                        }
                    ],
                    order: [[0, 'desc']],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                        '<"row"<"col-sm-12"Bt>>' +
                        '<"row"<"col-sm-12"tr>>' +
                        '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    buttons: [
                        {
                            extend: 'collection',
                            text: '<i class="fas fa-download"></i> Export',
                            className: 'btn btn-primary',
                            buttons: [
                                {
                                    extend: 'copy',
                                    text: '<i class="fas fa-copy"></i> Copy',
                                    className: 'btn btn-info',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'excel',
                                    text: '<i class="fas fa-file-excel"></i> Excel',
                                    className: 'btn btn-success',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'csv',
                                    text: '<i class="fas fa-file-csv"></i> CSV',
                                    className: 'btn btn-warning',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'pdf',
                                    text: '<i class="fas fa-file-pdf"></i> PDF',
                                    className: 'btn btn-danger',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'print',
                                    text: '<i class="fas fa-print"></i> Print',
                                    className: 'btn btn-dark',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                }
                            ]
                        }
                    ]
                });
                
                console.log("DataTable initialized");
                
                // Initialize column selection in the export modal
                initExportOptionsModal(table);
                
                // Export button handlers
                $('#exportExcel').on('click', function() {
                    showExportOptions('excel');
                });
                
                $('#exportPDF').on('click', function() {
                    showExportOptions('pdf');
                });
                
                $('#exportCSV').on('click', function() {
                    showExportOptions('csv');
                });
                
                $('#printResults').on('click', function() {
                    showExportOptions('print');
                });
                
                // Handle the actual export
                $('#proceedExport').on('click', function() {
                    try {
                        const exportType = $('#proceedExport').data('exportType');
                        const allPages = $('#exportAllPages').prop('checked');
                        const filename = $('#exportFilename').val() || 'students_data';
                        
                        // Get selected columns
                        const selectedColumns = [];
                        $('#columnCheckboxes input:checked').each(function() {
                            selectedColumns.push(parseInt($(this).val(), 10));
                        });
                        
                        // Create export options
                        const exportOptions = {
                            columns: selectedColumns,
                            modifier: {
                                search: allPages ? 'applied' : '',
                                page: allPages ? 'all' : 'current'
                            }
                        };
                        
                        console.log("Export type:", exportType);
                        console.log("Export options:", exportOptions);
                        
                        // Check if export libraries are loaded for PDF
                        if (exportType === 'pdf' && (typeof pdfMake === 'undefined' || typeof JSZip !== 'function')) {
                            console.warn("PDF libraries not loaded, using direct download link");
                            window.location.href = "{% url 'export_filtered_students_pdf' %}";
                            $('#exportOptionsModal').modal('hide');
                            return;
                        }
                        
                        // Execute the export
                        if (exportType === 'excel') {
                            table.button('.buttons-excel').trigger({
                                exportOptions: exportOptions,
                                filename: filename
                            });
                        } else if (exportType === 'pdf') {
                            // Add some extra debug info
                            console.log("PDF export started");
                            console.log("pdfMake available:", typeof pdfMake !== 'undefined');
                            console.log("JSZip available:", typeof JSZip === 'function');
                            
                            try {
                                table.button('.buttons-pdf').trigger({
                                    exportOptions: exportOptions,
                                    filename: filename
                                });
                            } catch (err) {
                                console.error("PDF export error:", err);
                                alert("There was an error generating the PDF. Using alternative download method.");
                                window.location.href = "{% url 'export_filtered_students_pdf' %}";
                            }
                        } else if (exportType === 'csv') {
                            table.button('.buttons-csv').trigger({
                                exportOptions: exportOptions,
                                filename: filename
                            });
                        } else if (exportType === 'print') {
                            table.button('.buttons-print').trigger({
                                exportOptions: exportOptions
                            });
                        }
                        
                        // Close the modal
                        $('#exportOptionsModal').modal('hide');
                    } catch (err) {
                        console.error("Export error:", err);
                        alert("Export failed. Please try using the direct download links at the bottom of the export options.");
                    }
                });
            
                // Handle filter form submission with debouncing
                let filterTimeout;
                $('#filterForm').on('submit', function (e) {
                    e.preventDefault();
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle filter input changes with debouncing
                $('#filterForm input, #filterForm select').on('change keyup', function () {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle reset button
                $('#resetFilters').on('click', function () {
                    $('#filterForm')[0].reset();
                    updateActiveFilters();
                    table.ajax.reload();
                });

                // Update active filters display
                function updateActiveFilters() {
                    const activeFilters = $('#activeFilters');
                    activeFilters.empty();

                    const filters = {
                        'ID': $('#id').val(),
                        'Name': $('#name').val(),
                        'Email': $('#email').val(),
                        'Phone': $('#phone').val(),
                        'Course': $('#course').val(),
                        'Year': $('#year').val(),
                        'CGPA': $('#cgpa').val() ? $('#cgpa_operator').val() + ' ' + $('#cgpa').val() : '',
                        'Status': $('#status').val(),
                        'Companies Left': $('#companies_left').val() ? $('#companies_operator').val() + ' ' + $('#companies_left').val() : '',
                        'Profile Score': $('#profile_score').val() ? $('#score_operator').val() + ' ' + $('#profile_score').val() : '',
                        'Company': $('#company').val(),
                        'Job': $('#job').val(),
                        'Attendance': $('#attendance_status').val() ? $('#attendance_status').val().replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''
                    };

                    for (const [key, value] of Object.entries(filters)) {
                        if (value) {
                            const badge = $('<span>')
                                .addClass('badge bg-primary filter-badge')
                                .text(`${key}: ${value}`);
                            activeFilters.append(badge);
                        }
                    }
                }
                
                // Function to initialize export options modal
                function initExportOptionsModal(table) {
                    const columnContainer = $('#columnCheckboxes');
                    
                    // Clear existing content
                    columnContainer.empty();
                    
                    // Add checkbox for each exportable column
                    table.columns().every(function(index) {
                        if (index < table.columns().count() - 1) { // Skip the actions column
                            const columnTitle = $(table.column(index).header()).text();
                            const columnCheckbox = $(`
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="${index}" id="column${index}" checked>
                                        <label class="form-check-label" for="column${index}">
                                            ${columnTitle}
                                        </label>
                                    </div>
                                </div>
                            `);
                            columnContainer.append(columnCheckbox);
                        }
                    });
                }
                
                // Function to show export options modal
                function showExportOptions(exportType) {
                    // Set the export type on the proceed button
                    $('#proceedExport').data('exportType', exportType);
                    
                    // Set modal title based on export type
                    let modalTitle = 'Export Options';
                    switch(exportType) {
                        case 'excel':
                            modalTitle = 'Export to Excel';
                            break;
                        case 'pdf':
                            modalTitle = 'Export to PDF';
                            break;
                        case 'csv':
                            modalTitle = 'Export to CSV';
                            break;
                        case 'print':
                            modalTitle = 'Print Data';
                            break;
                    }
                    
                    $('#exportOptionsModalLabel').text(modalTitle);
                    
                    // Add file extension to filename field
                    let fileExtension = '';
                    switch(exportType) {
                        case 'excel':
                            fileExtension = '.xlsx';
                            break;
                        case 'pdf':
                            fileExtension = '.pdf';
                            break;
                        case 'csv':
                            fileExtension = '.csv';
                            break;
                    }
                    
                    const baseFilename = 'students_data';
                    $('#exportFilename').val(baseFilename + fileExtension);
                    
                    // Show the modal
                    $('#exportOptionsModal').modal('show');
                }

                // Initialize active filters
                updateActiveFilters();
            }
        } catch (error) {
            console.error('Error initializing DataTable:', error);
            alert('An error occurred while initializing the page. Please refresh or contact support.');
        }
    }

    // Make sure jQuery and all libraries are loaded before initializing
    if (typeof jQuery === 'undefined') {
        window.addEventListener('load', function() {
            setTimeout(initPage, 500);
        });
    } else {
        $(document).ready(function() {
            // Add a small delay to ensure all libraries are fully loaded
            setTimeout(initPage, 200);
        });
    }
</script>

<script>
$(document).ready(function() {
    // Define getCurrentFilters at the global scope
    function getCurrentFilters() {
        return {
            id: $('#id').val() || '',
            name: $('#name').val() || '',
            email: $('#email').val() || '',
            phone: $('#phone').val() || '',
            course: $('#course').val() || '',
            year: $('#year').val() || '',
            cgpa: $('#cgpa').val() || '',
            cgpa_operator: $('#cgpa_operator').val() || '=',
            status: $('#status').val() || '',
            companies_left: $('#companies_left').val() || '',
            companies_operator: $('#companies_operator').val() || '=',
            profile_score: $('#profile_score').val() || '',
            score_operator: $('#score_operator').val() || '=',
            company: $('#company').val() || '',
            job: $('#job').val() || '',
            attendance_status: $('#attendance_status').val() || ''
        };
    }

    // Function to create export URL with filter parameters
    function createFilteredExportUrl(format) {
        const filters = getCurrentFilters();
        let url = '/administration/export_filtered_students?format=' + format;
        
        // Add filter parameters to URL
        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                url += '&' + key + '=' + encodeURIComponent(filters[key]);
            }
        });
        
        console.log("Export URL:", url);
        return url;
    }

    // Function for reliable downloads via iframe
    function downloadViaIframe(url) {
        $('#loadingOverlay').css('display', 'flex');
        
        try {
            // Create temporary iframe for download
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Set iframe source to our export URL
            iframe.src = url;
            
            // Set a timeout to remove the iframe and hide loading overlay
            setTimeout(function() {
                $('#loadingOverlay').hide();
                setTimeout(function() {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 5000);
            }, 3000);
        } catch (e) {
            console.error("Download error:", e);
            $('#loadingOverlay').hide();
            alert("Export failed: " + e.message);
        }
    }

    // Function to export documents based on type
    function exportDocuments(exportType) {
        $('#loadingOverlay').css('display', 'flex');
        
        try {
            // Create document export URL with current filters
            let url = '/administration/export_filtered_documents?export_type=' + exportType;
            
            // Add all current filter parameters
            const filters = getCurrentFilters();
            Object.keys(filters).forEach(key => {
                if (filters[key]) {
                    url += '&' + key + '=' + encodeURIComponent(filters[key]);
                }
            });
            
            console.log("Document export URL:", url);
            
            // Create temporary iframe for download
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Set iframe source to export URL
            iframe.src = url;
            
            // Set timeout to remove iframe and hide loading overlay
            setTimeout(function() {
                $('#loadingOverlay').hide();
                setTimeout(function() {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 5000);
            }, 3000);
        } catch (e) {
            console.error("Document export error:", e);
            $('#loadingOverlay').hide();
            alert("Export failed: " + e.message);
        }
    }

    // Setup export button click handlers when document is ready
    console.log("Setting up export handlers");
    
    $('#filteredExportCSV').click(function(e) {
        e.preventDefault();
        console.log("CSV export clicked");
        downloadViaIframe(createFilteredExportUrl('csv'));
    });
    
    $('#filteredExportExcel').click(function(e) {
        e.preventDefault();
        console.log("Excel export clicked");
        downloadViaIframe(createFilteredExportUrl('excel'));
    });
    
    $('#filteredExportHTML').click(function(e) {
        e.preventDefault();
        console.log("HTML export clicked");
        downloadViaIframe(createFilteredExportUrl('html'));
    });
    
    $('#filteredExportPDF').click(function(e) {
        e.preventDefault();
        console.log("PDF export clicked");
        // Using HTML format for PDF is more reliable
        downloadViaIframe(createFilteredExportUrl('html'));
    });
    
    // Document export handlers
    $('#exportAllDocuments').click(function(e) {
        e.preventDefault();
        console.log("All documents export clicked");
        exportDocuments('all');
    });
    
    $('#exportResumes').click(function(e) {
        e.preventDefault();
        console.log("Resumes export clicked");
        exportDocuments('resume');
    });
    
    $('#exportMarksheets').click(function(e) {
        e.preventDefault();
        console.log("Marksheets export clicked");
        exportDocuments('marksheets');
    });
    
    $('#exportProfiles').click(function(e) {
        e.preventDefault();
        console.log("Profiles export clicked");
        exportDocuments('profile');
    });
});
</script>

<script>
    // Function to sync main filters to direct form
    function syncMainFiltersToDirectForm() {
        if ($('#syncFilters').prop('checked')) {
            const directForm = $('form[action="/administration/export_filtered_students"]');
            
            // Clear any existing hidden fields
            directForm.find('input[type="hidden"]:not([name="format"])').remove();
            
            // Add all filter values as hidden fields
            $('#filterForm input, #filterForm select').each(function() {
                const input = $(this);
                const name = input.attr('name');
                const value = input.val();
                
                if (name && value) {
                    directForm.append(`<input type="hidden" name="${name}" value="${value}">`);
                }
            });
            
            // Update the display of active filters
            const filterTexts = [];
            $('#activeFilters .filter-badge').each(function() {
                filterTexts.push($(this).text());
            });
            
            $('#directFormFilters').text(filterTexts.join(', ') || 'No filters set');
        }
    }
    
    // Update filters when the sync checkbox changes
    $('#syncFilters').on('change', syncMainFiltersToDirectForm);
    
    // Update filters when the main form changes
    $('#filterForm').on('submit', syncMainFiltersToDirectForm);
    $('#filterForm input, #filterForm select').on('change keyup', function() {
        // Add debounce for performance
        clearTimeout(window.filterSyncTimeout);
        window.filterSyncTimeout = setTimeout(syncMainFiltersToDirectForm, 500);
    });
    
    // Sync filters once on page load
    $(document).ready(function() {
        setTimeout(syncMainFiltersToDirectForm, 1000);
    });
</script>

<script>
    // Function to update the hidden input fields in the message form with current filter values
    function updateMessageFormFields() {
        // Get all filter values
        const filters = {
            id: $('#id').val() || '',
            name: $('#name').val() || '',
            email: $('#email').val() || '',
            phone: $('#phone').val() || '',
            course: $('#course').val() || '',
            year: $('#year').val() || '',
            cgpa: $('#cgpa').val() || '',
            cgpa_operator: $('#cgpa_operator').val() || '=',
            status: $('#status').val() || '',
            companies_left: $('#companies_left').val() || '',
            companies_operator: $('#companies_operator').val() || '=',
            profile_score: $('#profile_score').val() || '',
            score_operator: $('#score_operator').val() || '=',
            company: $('#company').val() || '',
            job: $('#job').val() || '',
            attendance_status: $('#attendance_status').val() || ''
        };
        
        console.log("Updating message form with filters:", filters);
        
        // Update hidden fields in message form
        $('#msg_id').val(filters.id);
        $('#msg_name').val(filters.name);
        $('#msg_email').val(filters.email);
        $('#msg_phone').val(filters.phone);
        $('#msg_course').val(filters.course);
        $('#msg_year').val(filters.year);
        $('#msg_cgpa').val(filters.cgpa);
        $('#msg_cgpa_operator').val(filters.cgpa_operator);
        $('#msg_status').val(filters.status);
        $('#msg_companies_left').val(filters.companies_left);
        $('#msg_companies_operator').val(filters.companies_operator);
        $('#msg_profile_score').val(filters.profile_score);
        $('#msg_score_operator').val(filters.score_operator);
        $('#msg_company').val(filters.company);
        $('#msg_job').val(filters.job);
        $('#msg_attendance_status').val(filters.attendance_status);
    }
    
    // Update message form fields when filter form changes
    $('#filterForm input, #filterForm select').on('change keyup', function() {
        updateMessageFormFields();
    });
    
    // Update message form fields when filter form is submitted
    $('#filterForm').on('submit', function() {
        updateMessageFormFields();
    });
    
    // Update message form fields on page load
    $(document).ready(function() {
        updateMessageFormFields();
        
        // Force update message form immediately before submission
        $('#messageForm').on('submit', function(e) {
            updateMessageFormFields();
            // Debug output
            console.log("Message form submitted with params:", {
                id: $('#msg_id').val(),
                name: $('#msg_name').val(), 
                email: $('#msg_email').val(),
                companies_left: $('#msg_companies_left').val(),
                companies_operator: $('#msg_companies_operator').val(),
                company: $('#msg_company').val(),
                job: $('#msg_job').val(),
                attendance_status: $('#msg_attendance_status').val()
            });
        });
    });
</script>
{% endblock %}