{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Advanced Filter Page{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_filter {
        float: none;
        text-align: left;
    }

    .dataTables_wrapper .dataTables_length {
        float: none;
        text-align: left;
    }

    .active-filters {
        margin: 10px 0;
    }

    .filter-badge {
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .dt-buttons {
        margin-bottom: 15px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
    }
</style>
{% endblock %}

{% block body %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Advanced Filter Page</h3>
                </div>
                <div class="card-body">
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="id" class="form-label">ID</label>
                                <input type="text" class="form-control" id="id" name="id" placeholder="Search by ID...">
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name"
                                    placeholder="Search by name...">
                            </div>
                            <div class="col-md-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email"
                                    placeholder="Search by email...">
                            </div>
                            <div class="col-md-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone" name="phone"
                                    placeholder="Search by phone...">
                            </div>
                            <div class="col-md-3">
                                <label for="course" class="form-label">Course</label>
                                <select class="form-select" id="course" name="course">
                                    <option value="">All Courses</option>
                                    <option value="B.Tech">B.Tech</option>
                                    <option value="BBA">BBA</option>
                                    <option value="BCA">BCA</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year">
                                    <option value="">All Years</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="cgpa" class="form-label">CGPA</label>
                                <div class="input-group">
                                    <select class="form-select" id="cgpa_operator" name="cgpa_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="cgpa" name="cgpa" placeholder="CGPA"
                                        step="0.01" min="0" max="10">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Status</option>
                                    <option value="Current Student">Current Student</option>
                                    <option value="Alumni">Alumni</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="companies_left" class="form-label">Companies Left</label>
                                <div class="input-group">
                                    <select class="form-select" id="companies_operator" name="companies_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="companies_left" name="companies_left"
                                        placeholder="Number" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="profile_score" class="form-label">Profile Score</label>
                                <div class="input-group">
                                    <select class="form-select" id="score_operator" name="score_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="profile_score" name="profile_score"
                                        placeholder="Score" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                                <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Filters -->
                    <div class="active-filters" id="activeFilters"></div>

                    <!-- DataTable -->
                    <div class="table-responsive">
                        <table id="dataTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>CGPA</th>
                                    <th>Status</th>
                                    <th>Companies Left</th>
                                    <th>Profile Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Required JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Load DataTables Core and Extensions -->
<script type="text/javascript">
    // Check if jQuery loaded
    if (typeof jQuery === 'undefined') {
        document.write('<script src="{% static "js/dashboard/libs/jquery/dist/jquery.min.js" %}"><\/script>');
        console.warn('Local jQuery loaded as fallback');
    }
</script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

<!-- Export Buttons Libraries -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- ApexCharts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/4.5.0/apexcharts.min.js"></script>

<!-- Custom Dashboard JS -->
<script src="{% static 'js/dashboard/dashboard.js' %}"></script>

<script>
    // Wait for document ready with a safety timeout
    function initPage() {
        try {
            const loadingOverlay = $('#loadingOverlay');
            
            // Check if DataTable is available
            if (typeof $.fn.DataTable !== 'function') {
                console.error('DataTables library not properly loaded');
                // Try to load it again from a different source
                $.getScript("https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js")
                    .done(function() {
                        console.log("Successfully loaded DataTables from alternate source");
                        setTimeout(initializeDataTable, 500);
                    })
                    .fail(function() {
                        alert('Error: DataTables library could not be loaded. Please refresh the page or contact support.');
                    });
                return;
            }

            initializeDataTable();

            function initializeDataTable() {
                console.log("Initializing DataTable...");
                // Initialize DataTable with optimized settings
                const table = $('#dataTable').DataTable({
                    processing: true,
                    serverSide: true,
                    pageLength: 25,
                    deferRender: true,
                    searchDelay: 500,
                    ajax: {
                        url: '/accounts/api/datatables/students/',
                        type: 'GET',
                        data: function (d) {
                            // Add filter parameters
                            d.id = $('#id').val();
                            d.name = $('#name').val();
                            d.email = $('#email').val();
                            d.phone = $('#phone').val();
                            d.course = $('#course').val();
                            d.year = $('#year').val();
                            d.cgpa = $('#cgpa').val();
                            d.cgpa_operator = $('#cgpa_operator').val();
                            d.status = $('#status').val();
                            d.companies_left = $('#companies_left').val();
                            d.companies_operator = $('#companies_operator').val();
                            d.profile_score = $('#profile_score').val();
                            d.score_operator = $('#score_operator').val();
                            console.log("DataTable parameters:", d);
                            return d;
                        },
                        beforeSend: function () {
                            loadingOverlay.css('display', 'flex');
                        },
                        complete: function () {
                            loadingOverlay.hide();
                        },
                        error: function (xhr, error, thrown) {
                            console.error('DataTables error:', error, thrown);
                            loadingOverlay.hide();
                            alert('Error loading data. Please try again.');
                        }
                    },
                    columns: [
                        { data: 'id' },
                        {
                            data: null,
                            render: function (data) {
                                return data.first_name + ' ' + data.last_name;
                            }
                        },
                        { data: 'username' },
                        { data: 'phone_number' },
                        { data: 'course' },
                        { data: 'year' },
                        {
                            data: 'cgpa',
                            render: function (data) {
                                return data ? data.toFixed(2) : '-';
                            }
                        },
                        { data: 'alumni_status' },
                        { data: 'no_of_companies_left' },
                        {
                            data: 'profile_score',
                            render: function (data) {
                                return data + '%';
                            }
                        },
                        {
                            data: 'actions',
                            orderable: false,
                            searchable: false
                        }
                    ],
                    order: [[0, 'desc']],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                        '<"row"<"col-sm-12"Bt>>' +
                        '<"row"<"col-sm-12"tr>>' +
                        '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    buttons: [
                        {
                            extend: 'collection',
                            text: '<i class="fas fa-download"></i> Export',
                            className: 'btn btn-primary',
                            buttons: [
                                {
                                    extend: 'copy',
                                    text: '<i class="fas fa-copy"></i> Copy',
                                    className: 'btn btn-info',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'excel',
                                    text: '<i class="fas fa-file-excel"></i> Excel',
                                    className: 'btn btn-success',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'csv',
                                    text: '<i class="fas fa-file-csv"></i> CSV',
                                    className: 'btn btn-warning',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'pdf',
                                    text: '<i class="fas fa-file-pdf"></i> PDF',
                                    className: 'btn btn-danger',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'print',
                                    text: '<i class="fas fa-print"></i> Print',
                                    className: 'btn btn-dark',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                }
                            ]
                        }
                    ]
                });
                
                console.log("DataTable initialized");
            
                // Handle filter form submission with debouncing
                let filterTimeout;
                $('#filterForm').on('submit', function (e) {
                    e.preventDefault();
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle filter input changes with debouncing
                $('#filterForm input, #filterForm select').on('change keyup', function () {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle reset button
                $('#resetFilters').on('click', function () {
                    $('#filterForm')[0].reset();
                    updateActiveFilters();
                    table.ajax.reload();
                });

                // Update active filters display
                function updateActiveFilters() {
                    const activeFilters = $('#activeFilters');
                    activeFilters.empty();

                    const filters = {
                        'ID': $('#id').val(),
                        'Name': $('#name').val(),
                        'Email': $('#email').val(),
                        'Phone': $('#phone').val(),
                        'Course': $('#course').val(),
                        'Year': $('#year').val(),
                        'CGPA': $('#cgpa').val() ? $('#cgpa_operator').val() + ' ' + $('#cgpa').val() : '',
                        'Status': $('#status').val(),
                        'Companies Left': $('#companies_left').val() ? $('#companies_operator').val() + ' ' + $('#companies_left').val() : '',
                        'Profile Score': $('#profile_score').val() ? $('#score_operator').val() + ' ' + $('#profile_score').val() : ''
                    };

                    for (const [key, value] of Object.entries(filters)) {
                        if (value) {
                            const badge = $('<span>')
                                .addClass('badge bg-primary filter-badge')
                                .text(`${key}: ${value}`);
                            activeFilters.append(badge);
                        }
                    }
                }

                // Initialize active filters
                updateActiveFilters();
            }
        } catch (error) {
            console.error('Error initializing DataTable:', error);
            alert('An error occurred while initializing the page. Please refresh or contact support.');
        }
    }

    // Make sure jQuery and all libraries are loaded before initializing
    if (typeof jQuery === 'undefined') {
        window.addEventListener('load', function() {
            setTimeout(initPage, 500);
        });
    } else {
        $(document).ready(function() {
            // Add a small delay to ensure all libraries are fully loaded
            setTimeout(initPage, 200);
        });
    }
</script>
{% endblock %}