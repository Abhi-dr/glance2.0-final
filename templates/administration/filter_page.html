{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Advanced Filter Page{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_filter {
        float: none;
        text-align: left;
    }

    .dataTables_wrapper .dataTables_length {
        float: none;
        text-align: left;
    }

    .active-filters {
        margin: 10px 0;
    }

    .filter-badge {
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .dt-buttons {
        margin-bottom: 15px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
    }
</style>
{% endblock %}

{% block body %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Advanced Filter Page</h3>
                </div>
                <div class="card-body">
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="id" class="form-label">ID</label>
                                <input type="text" class="form-control" id="id" name="id" placeholder="Search by ID...">
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name"
                                    placeholder="Search by name...">
                            </div>
                            <div class="col-md-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email"
                                    placeholder="Search by email...">
                            </div>
                            <div class="col-md-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone" name="phone"
                                    placeholder="Search by phone...">
                            </div>
                            <div class="col-md-3">
                                <label for="course" class="form-label">Course</label>
                                <select class="form-select" id="course" name="course">
                                    <option value="">All Courses</option>
                                    <option value="B.Tech">B.Tech</option>
                                    <option value="BBA">BBA</option>
                                    <option value="BCA">BCA</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year">
                                    <option value="">All Years</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="cgpa" class="form-label">CGPA</label>
                                <div class="input-group">
                                    <select class="form-select" id="cgpa_operator" name="cgpa_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="cgpa" name="cgpa" placeholder="CGPA"
                                        step="0.01" min="0" max="10">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Status</option>
                                    <option value="Current Student">Current Student</option>
                                    <option value="Alumni">Alumni</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="companies_left" class="form-label">Companies Left</label>
                                <div class="input-group">
                                    <select class="form-select" id="companies_operator" name="companies_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="companies_left" name="companies_left"
                                        placeholder="Number" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="profile_score" class="form-label">Profile Score</label>
                                <div class="input-group">
                                    <select class="form-select" id="score_operator" name="score_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="profile_score" name="profile_score"
                                        placeholder="Score" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                                <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Filters -->
                    <div class="active-filters" id="activeFilters"></div>

                    <!-- Export Options Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Export Filtered Students</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="btn-group w-100 mb-3" role="group" aria-label="Export options">
                                        <button type="button" class="btn btn-success" id="exportExcel">
                                            <i class="fas fa-file-excel me-2"></i>Export to Excel
                                        </button>
                                        <button type="button" class="btn btn-danger" id="exportPDF">
                                            <i class="fas fa-file-pdf me-2"></i>Export to PDF
                                        </button>
                                        <button type="button" class="btn btn-warning" id="exportCSV">
                                            <i class="fas fa-file-csv me-2"></i>Export to CSV
                                        </button>
                                        <button type="button" class="btn btn-info" id="printResults">
                                            <i class="fas fa-print me-2"></i>Print Results
                                        </button>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="exportAllPages" checked>
                                        <label class="form-check-label" for="exportAllPages">Export all filtered records (not just current page)</label>
                                    </div>
                                    <hr>
                                    <div class="mt-3">
                                        <h6>Alternative Direct Downloads:</h6>
                                        <div class="btn-group mt-2 w-100" role="group">
                                            <a href="{% url 'export_unapplied_students_csv' %}" class="btn btn-outline-success" download>
                                                <i class="fas fa-download me-1"></i> Unapplied Students
                                            </a>
                                            <a href="{% url 'export_uneligible_students' %}" class="btn btn-outline-primary" download>
                                                <i class="fas fa-download me-1"></i> Uneligible Students
                                            </a>
                                            <a href="{% url 'export_company_applications_summary_csv' %}" class="btn btn-outline-info" download>
                                                <i class="fas fa-download me-1"></i> Companies Summary
                                            </a>
                                        </div>
                                        <div class="mt-2">
                                            <a href="{% url 'export_filtered_students_pdf' %}" class="btn btn-outline-danger w-100" download>
                                                <i class="fas fa-file-pdf me-1"></i> Direct PDF Export (Server-side)
                                            </a>
                                            <small class="text-muted d-block mt-1">Use this option if the PDF export button isn't working.</small>
                                        </div>
                                        
                                        <!-- Server-side Filtered Exports -->
                                        <div class="mt-4">
                                            <h6>Server-side Filtered Exports:</h6>
                                            <p class="small text-muted mb-2">These buttons will export data with your current filters applied.</p>
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-primary" id="server-filter-export">
                                                    <i class="fas fa-filter me-1"></i> Export with Current Filters
                                                </button>
                                            </div>
                                            <div class="btn-group w-100 mt-2" role="group">
                                                <button type="button" class="btn btn-outline-success" id="server-filter-csv">
                                                    <i class="fas fa-file-csv me-1"></i> CSV
                                                </button>
                                                <button type="button" class="btn btn-outline-success" id="server-filter-excel">
                                                    <i class="fas fa-file-excel me-1"></i> Excel
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" id="server-filter-html">
                                                    <i class="fas fa-file-code me-1"></i> HTML
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Server-Side Export Options Card -->
                    <div class="card mb-4 mt-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Server-Side Export (Recommended)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <p class="mb-3">These export options work directly on the server and are more reliable than browser-based exports.</p>
                                    <div class="d-grid gap-2 mb-3">
                                        <button type="button" class="btn btn-lg btn-success" id="main-server-filter-export">
                                            <i class="fas fa-file-export me-2"></i> Export Current Filter Results
                                        </button>
                                    </div>
                                    <div id="server-export-formats" style="display:none;">
                                        <p class="mb-2">Select export format:</p>
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary" id="main-server-filter-csv">
                                                <i class="fas fa-file-csv me-2"></i> CSV
                                            </button>
                                            <button type="button" class="btn btn-outline-success" id="main-server-filter-excel">
                                                <i class="fas fa-file-excel me-2"></i> Excel (.xls)
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" id="main-server-filter-html">
                                                <i class="fas fa-file-code me-2"></i> HTML
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Direct Download Links -->
                    <div class="mt-4">
                        <h6>Direct Download Links (Fixed):</h6>
                        <div class="btn-group w-100 mt-2" role="group">
                            <a href="/administration/export_unapplied_students_csv" class="btn btn-outline-success" download>
                                <i class="fas fa-file-csv me-1"></i> Unapplied CSV
                            </a>
                            <a href="/administration/export_uneligible_students" class="btn btn-outline-primary" download>
                                <i class="fas fa-file-csv me-1"></i> Uneligible CSV
                            </a>
                            <a href="/administration/export_filtered_students_pdf" class="btn btn-outline-danger" download>
                                <i class="fas fa-file-pdf me-1"></i> PDF Export
                            </a>
                        </div>
                        <div class="btn-group w-100 mt-2" role="group">
                            <a href="/administration/export_filtered_students/?format=csv" class="btn btn-outline-success" download>
                                <i class="fas fa-file-csv me-1"></i> Filtered CSV
                            </a>
                            <a href="/administration/export_filtered_students/?format=excel" class="btn btn-outline-success" download>
                                <i class="fas fa-file-excel me-1"></i> Filtered Excel
                            </a>
                            <a href="/administration/export_filtered_students/?format=html" class="btn btn-outline-danger" download>
                                <i class="fas fa-file-code me-1"></i> Filtered HTML
                            </a>
                        </div>
                    </div>

                    <!-- DataTable -->
                    <div class="table-responsive">
                        <table id="dataTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>CGPA</th>
                                    <th>Status</th>
                                    <th>Companies Left</th>
                                    <th>Profile Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom export modal for additional options -->
<div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exportOptionsModalLabel">Export Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="mb-3">
                        <label class="form-label">Select Columns to Export</label>
                        <div id="columnCheckboxes" class="row">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="exportTitle" class="form-label">Export Title</label>
                        <input type="text" class="form-control" id="exportTitle" value="Filtered Students Data">
                    </div>
                    <div class="mb-3">
                        <label for="exportFilename" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="exportFilename" value="students_data">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="proceedExport">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Required JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Load DataTables Core and Extensions -->
<script type="text/javascript">
    // Check if jQuery loaded
    if (typeof jQuery === 'undefined') {
        document.write('<script src="{% static "js/dashboard/libs/jquery/dist/jquery.min.js" %}"><\/script>');
        console.warn('Local jQuery loaded as fallback');
    }
</script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

<!-- Export Buttons Libraries -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- ApexCharts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/4.5.0/apexcharts.min.js"></script>

<!-- Custom Dashboard JS -->
<script src="{% static 'js/dashboard/dashboard.js' %}"></script>

<script>
    // Wait for document ready with a safety timeout
    function initPage() {
        try {
            const loadingOverlay = $('#loadingOverlay');
            
            // Check if DataTable is available
            if (typeof $.fn.DataTable !== 'function') {
                console.error('DataTables library not properly loaded');
                // Try to load it again from a different source
                $.getScript("https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js")
                    .done(function() {
                        console.log("Successfully loaded DataTables from alternate source");
                        setTimeout(initializeDataTable, 500);
                    })
                    .fail(function() {
                        alert('Error: DataTables library could not be loaded. Please refresh the page or contact support.');
                    });
                return;
            }
            
            // Check if export libraries are loaded
            if (typeof JSZip !== 'function' || typeof pdfMake === 'undefined') {
                console.warn('Export libraries not fully loaded, attempting to load them...');
                // Try to load export libraries
                $.when(
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"),
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"),
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"),
                    $.getScript("https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"),
                    $.getScript("https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js")
                ).done(function() {
                    console.log("Successfully loaded export libraries");
                    setTimeout(initializeDataTable, 500);
                }).fail(function() {
                    console.error("Failed to load export libraries");
                    alert('Warning: Export functionality may be limited. Please try using the direct download links instead.');
                    initializeDataTable();
                });
            } else {
                initializeDataTable();
            }

            function initializeDataTable() {
                console.log("Initializing DataTable...");
                // Initialize DataTable with optimized settings
                const table = $('#dataTable').DataTable({
                    processing: true,
                    serverSide: true,
                    pageLength: 25,
                    deferRender: true,
                    searchDelay: 500,
                    ajax: {
                        url: '/accounts/api/datatables/students/',
                        type: 'GET',
                        data: function (d) {
                            // Add filter parameters
                            d.id = $('#id').val();
                            d.name = $('#name').val();
                            d.email = $('#email').val();
                            d.phone = $('#phone').val();
                            d.course = $('#course').val();
                            d.year = $('#year').val();
                            d.cgpa = $('#cgpa').val();
                            d.cgpa_operator = $('#cgpa_operator').val();
                            d.status = $('#status').val();
                            d.companies_left = $('#companies_left').val();
                            d.companies_operator = $('#companies_operator').val();
                            d.profile_score = $('#profile_score').val();
                            d.score_operator = $('#score_operator').val();
                            console.log("DataTable parameters:", d);
                            return d;
                        },
                        beforeSend: function () {
                            loadingOverlay.css('display', 'flex');
                        },
                        complete: function () {
                            loadingOverlay.hide();
                        },
                        error: function (xhr, error, thrown) {
                            console.error('DataTables error:', error, thrown);
                            loadingOverlay.hide();
                            alert('Error loading data. Please try again.');
                        }
                    },
                    columns: [
                        { data: 'id' },
                        {
                            data: null,
                            render: function (data) {
                                return data.first_name + ' ' + data.last_name;
                            }
                        },
                        { data: 'username' },
                        { data: 'phone_number' },
                        { data: 'course' },
                        { data: 'year' },
                        {
                            data: 'cgpa',
                            render: function (data) {
                                return data ? data.toFixed(2) : '-';
                            }
                        },
                        { data: 'alumni_status' },
                        { data: 'no_of_companies_left' },
                        {
                            data: 'profile_score',
                            render: function (data) {
                                return data + '%';
                            }
                        },
                        {
                            data: 'actions',
                            orderable: false,
                            searchable: false
                        }
                    ],
                    order: [[0, 'desc']],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                        '<"row"<"col-sm-12"Bt>>' +
                        '<"row"<"col-sm-12"tr>>' +
                        '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    buttons: [
                        {
                            extend: 'collection',
                            text: '<i class="fas fa-download"></i> Export',
                            className: 'btn btn-primary',
                            buttons: [
                                {
                                    extend: 'copy',
                                    text: '<i class="fas fa-copy"></i> Copy',
                                    className: 'btn btn-info',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'excel',
                                    text: '<i class="fas fa-file-excel"></i> Excel',
                                    className: 'btn btn-success',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'csv',
                                    text: '<i class="fas fa-file-csv"></i> CSV',
                                    className: 'btn btn-warning',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'pdf',
                                    text: '<i class="fas fa-file-pdf"></i> PDF',
                                    className: 'btn btn-danger',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'print',
                                    text: '<i class="fas fa-print"></i> Print',
                                    className: 'btn btn-dark',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                }
                            ]
                        }
                    ]
                });
                
                console.log("DataTable initialized");
                
                // Initialize column selection in the export modal
                initExportOptionsModal(table);
                
                // Export button handlers
                $('#exportExcel').on('click', function() {
                    showExportOptions('excel');
                });
                
                $('#exportPDF').on('click', function() {
                    showExportOptions('pdf');
                });
                
                $('#exportCSV').on('click', function() {
                    showExportOptions('csv');
                });
                
                $('#printResults').on('click', function() {
                    showExportOptions('print');
                });
                
                // Handle the actual export
                $('#proceedExport').on('click', function() {
                    try {
                        const exportType = $('#proceedExport').data('exportType');
                        const allPages = $('#exportAllPages').prop('checked');
                        const filename = $('#exportFilename').val() || 'students_data';
                        
                        // Get selected columns
                        const selectedColumns = [];
                        $('#columnCheckboxes input:checked').each(function() {
                            selectedColumns.push(parseInt($(this).val(), 10));
                        });
                        
                        // Create export options
                        const exportOptions = {
                            columns: selectedColumns,
                            modifier: {
                                search: allPages ? 'applied' : '',
                                page: allPages ? 'all' : 'current'
                            }
                        };
                        
                        console.log("Export type:", exportType);
                        console.log("Export options:", exportOptions);
                        
                        // Check if export libraries are loaded for PDF
                        if (exportType === 'pdf' && (typeof pdfMake === 'undefined' || typeof JSZip !== 'function')) {
                            console.warn("PDF libraries not loaded, using direct download link");
                            window.location.href = "{% url 'export_filtered_students_pdf' %}";
                            $('#exportOptionsModal').modal('hide');
                            return;
                        }
                        
                        // Execute the export
                        if (exportType === 'excel') {
                            table.button('.buttons-excel').trigger({
                                exportOptions: exportOptions,
                                filename: filename
                            });
                        } else if (exportType === 'pdf') {
                            // Add some extra debug info
                            console.log("PDF export started");
                            console.log("pdfMake available:", typeof pdfMake !== 'undefined');
                            console.log("JSZip available:", typeof JSZip === 'function');
                            
                            try {
                                table.button('.buttons-pdf').trigger({
                                    exportOptions: exportOptions,
                                    filename: filename
                                });
                            } catch (err) {
                                console.error("PDF export error:", err);
                                alert("There was an error generating the PDF. Using alternative download method.");
                                window.location.href = "{% url 'export_filtered_students_pdf' %}";
                            }
                        } else if (exportType === 'csv') {
                            table.button('.buttons-csv').trigger({
                                exportOptions: exportOptions,
                                filename: filename
                            });
                        } else if (exportType === 'print') {
                            table.button('.buttons-print').trigger({
                                exportOptions: exportOptions
                            });
                        }
                        
                        // Close the modal
                        $('#exportOptionsModal').modal('hide');
                    } catch (err) {
                        console.error("Export error:", err);
                        alert("Export failed. Please try using the direct download links at the bottom of the export options.");
                    }
                });
            
                // Handle filter form submission with debouncing
                let filterTimeout;
                $('#filterForm').on('submit', function (e) {
                    e.preventDefault();
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle filter input changes with debouncing
                $('#filterForm input, #filterForm select').on('change keyup', function () {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle reset button
                $('#resetFilters').on('click', function () {
                    $('#filterForm')[0].reset();
                    updateActiveFilters();
                    table.ajax.reload();
                });

                // Update active filters display
                function updateActiveFilters() {
                    const activeFilters = $('#activeFilters');
                    activeFilters.empty();

                    const filters = {
                        'ID': $('#id').val(),
                        'Name': $('#name').val(),
                        'Email': $('#email').val(),
                        'Phone': $('#phone').val(),
                        'Course': $('#course').val(),
                        'Year': $('#year').val(),
                        'CGPA': $('#cgpa').val() ? $('#cgpa_operator').val() + ' ' + $('#cgpa').val() : '',
                        'Status': $('#status').val(),
                        'Companies Left': $('#companies_left').val() ? $('#companies_operator').val() + ' ' + $('#companies_left').val() : '',
                        'Profile Score': $('#profile_score').val() ? $('#score_operator').val() + ' ' + $('#profile_score').val() : ''
                    };

                    for (const [key, value] of Object.entries(filters)) {
                        if (value) {
                            const badge = $('<span>')
                                .addClass('badge bg-primary filter-badge')
                                .text(`${key}: ${value}`);
                            activeFilters.append(badge);
                        }
                    }
                }
                
                // Function to initialize export options modal
                function initExportOptionsModal(table) {
                    const columnContainer = $('#columnCheckboxes');
                    
                    // Clear existing content
                    columnContainer.empty();
                    
                    // Add checkbox for each exportable column
                    table.columns().every(function(index) {
                        if (index < table.columns().count() - 1) { // Skip the actions column
                            const columnTitle = $(table.column(index).header()).text();
                            const columnCheckbox = $(`
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="${index}" id="column${index}" checked>
                                        <label class="form-check-label" for="column${index}">
                                            ${columnTitle}
                                        </label>
                                    </div>
                                </div>
                            `);
                            columnContainer.append(columnCheckbox);
                        }
                    });
                }
                
                // Function to show export options modal
                function showExportOptions(exportType) {
                    // Set the export type on the proceed button
                    $('#proceedExport').data('exportType', exportType);
                    
                    // Set modal title based on export type
                    let modalTitle = 'Export Options';
                    switch(exportType) {
                        case 'excel':
                            modalTitle = 'Export to Excel';
                            break;
                        case 'pdf':
                            modalTitle = 'Export to PDF';
                            break;
                        case 'csv':
                            modalTitle = 'Export to CSV';
                            break;
                        case 'print':
                            modalTitle = 'Print Data';
                            break;
                    }
                    
                    $('#exportOptionsModalLabel').text(modalTitle);
                    
                    // Add file extension to filename field
                    let fileExtension = '';
                    switch(exportType) {
                        case 'excel':
                            fileExtension = '.xlsx';
                            break;
                        case 'pdf':
                            fileExtension = '.pdf';
                            break;
                        case 'csv':
                            fileExtension = '.csv';
                            break;
                    }
                    
                    const baseFilename = 'students_data';
                    $('#exportFilename').val(baseFilename + fileExtension);
                    
                    // Show the modal
                    $('#exportOptionsModal').modal('show');
                }

                // Initialize active filters
                updateActiveFilters();
                
                // Server-side export handlers
                $('#server-filter-export').on('click', function() {
                    // Show format options
                    $('#server-filter-csv, #server-filter-excel, #server-filter-html').toggle();
                });
                
                function buildFilteredExportUrl(format) {
                    // Get all current filter values
                    const filters = {
                        id: $('#id').val(),
                        name: $('#name').val(),
                        email: $('#email').val(),
                        phone: $('#phone').val(),
                        course: $('#course').val(),
                        year: $('#year').val(),
                        cgpa: $('#cgpa').val(),
                        cgpa_operator: $('#cgpa_operator').val(),
                        status: $('#status').val(),
                        companies_left: $('#companies_left').val(),
                        companies_operator: $('#companies_operator').val(),
                        format: format
                    };
                    
                    // Use direct URL path instead of Django URL resolver which may be causing issues
                    let url = "/administration/export_filtered_students/?";
                    
                    // Add non-empty parameters
                    for (const [key, value] of Object.entries(filters)) {
                        if (value) {
                            url += `${key}=${encodeURIComponent(value)}&`;
                        }
                    }
                    
                    // Remove trailing '&' if present
                    if (url.endsWith('&')) {
                        url = url.slice(0, -1);
                    }
                    
                    return url;
                }
                
                // Initially hide format buttons
                $('#server-filter-csv, #server-filter-excel, #server-filter-html').hide();
                
                // Handle format buttons
                $('#server-filter-csv').on('click', function() {
                    window.location.href = buildFilteredExportUrl('csv');
                });
                
                $('#server-filter-excel').on('click', function() {
                    window.location.href = buildFilteredExportUrl('excel');
                });
                
                $('#server-filter-html').on('click', function() {
                    window.location.href = buildFilteredExportUrl('html');
                });
                
                // Main server-side export button
                $('#main-server-filter-export').on('click', function() {
                    $('#server-export-formats').slideToggle();
                });
                
                // Main server-side format buttons
                $('#main-server-filter-csv').on('click', function() {
                    window.location.href = buildFilteredExportUrl('csv');
                });
                
                $('#main-server-filter-excel').on('click', function() {
                    window.location.href = buildFilteredExportUrl('excel');
                });
                
                $('#main-server-filter-html').on('click', function() {
                    window.location.href = buildFilteredExportUrl('html');
                });
            }
        } catch (error) {
            console.error('Error initializing DataTable:', error);
            alert('An error occurred while initializing the page. Please refresh or contact support.');
        }
    }

    // Make sure jQuery and all libraries are loaded before initializing
    if (typeof jQuery === 'undefined') {
        window.addEventListener('load', function() {
            setTimeout(initPage, 500);
        });
    } else {
        $(document).ready(function() {
            // Add a small delay to ensure all libraries are fully loaded
            setTimeout(initPage, 200);
        });
    }
</script>
{% endblock %}