{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Advanced Filter Page{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_filter {
        float: none;
        text-align: left;
    }

    .dataTables_wrapper .dataTables_length {
        float: none;
        text-align: left;
    }

    .active-filters {
        margin: 10px 0;
    }

    .filter-badge {
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .dt-buttons {
        margin-bottom: 15px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
    }

    .export-section {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .export-section h5 {
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .export-button {
        margin-right: 5px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block body %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Advanced Filter Page</h3>
                </div>
                <div class="card-body">
                    <!-- Quick Attendance Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="fw-bold mb-3">Quick Attendance Filters</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="?attendance_status=present" class="btn btn-success">
                                    <i class="fas fa-check-circle me-1"></i> Present Students
                                </a>
                                <a href="?attendance_status=absent" class="btn btn-danger">
                                    <i class="fas fa-times-circle me-1"></i> Absent Students
                                </a>
                                <a href="?attendance_status=not_marked" class="btn btn-warning">
                                    <i class="fas fa-hourglass-half me-1"></i> Not Marked
                                </a>
                                <a href="?" class="btn btn-outline-secondary">
                                    <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="id" class="form-label">ID</label>
                                <input type="text" class="form-control" id="id" name="id" placeholder="Search by ID...">
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name"
                                    placeholder="Search by name...">
                            </div>
                            <div class="col-md-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email"
                                    placeholder="Search by email...">
                            </div>
                            <div class="col-md-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone" name="phone"
                                    placeholder="Search by phone...">
                            </div>
                            <div class="col-md-3">
                                <label for="course" class="form-label">Course</label>
                                <div class="course-checkbox-group border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Computer Science" id="filter_cs">
                                        <label class="form-check-label" for="filter_cs">B.Tech Computer Science</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Information Technology" id="filter_it">
                                        <label class="form-check-label" for="filter_it">B.Tech Information Technology</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Electronics" id="filter_ec">
                                        <label class="form-check-label" for="filter_ec">B.Tech Electronics</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Biotech" id="filter_bt">
                                        <label class="form-check-label" for="filter_bt">B.Tech Biotech</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Civil" id="filter_ce">
                                        <label class="form-check-label" for="filter_ce">B.Tech Civil</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Electrical" id="filter_ee">
                                        <label class="form-check-label" for="filter_ee">B.Tech Electrical</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Tech Mechanical" id="filter_me">
                                        <label class="form-check-label" for="filter_me">B.Tech Mechanical</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="BCA" id="filter_bca">
                                        <label class="form-check-label" for="filter_bca">BCA</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="MCA" id="filter_mca">
                                        <label class="form-check-label" for="filter_mca">MCA</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="M.Tech Computer Science" id="filter_mcs">
                                        <label class="form-check-label" for="filter_mcs">M.Tech Computer Science</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="M.Tech Information Technology" id="filter_mit">
                                        <label class="form-check-label" for="filter_mit">M.Tech Information Technology</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="MBA" id="filter_mba">
                                        <label class="form-check-label" for="filter_mba">MBA</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="B.Com" id="filter_bcom">
                                        <label class="form-check-label" for="filter_bcom">B.Com</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="M.Com" id="filter_mcom">
                                        <label class="form-check-label" for="filter_mcom">M.Com</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="BBA" id="filter_bba">
                                        <label class="form-check-label" for="filter_bba">BBA</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input course-checkbox" type="checkbox" name="course" value="LLB" id="filter_llb">
                                        <label class="form-check-label" for="filter_llb">LLB</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="companies" class="form-label">Companies</label>
                                <div class="companies-checkbox-group border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    {% for company in companies %}
                                    <div class="form-check">
                                        <input class="form-check-input company-checkbox" type="checkbox" name="companies" value="{{ company.id }}" id="company_{{ company.id }}">
                                        <label class="form-check-label" for="company_{{ company.id }}">{{ company.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="jobs" class="form-label">Jobs</label>
                                <div class="jobs-checkbox-group border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    {% for job in jobs %}
                                    <div class="form-check job-option" data-company-id="{{ job.company.id }}">
                                        <input class="form-check-input job-checkbox" type="checkbox" name="jobs" value="{{ job.id }}" id="job_{{ job.id }}">
                                        <label class="form-check-label" for="job_{{ job.id }}">{{ job.title }} ({{ job.company.name }})</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="interview_date" class="form-label">Interview Date</label>
                                <select class="form-select" id="interview_date" name="interview_date" multiple>
                                    <option value="17th April, 2025">17th April, 2025</option>
                                    <option value="18th April, 2025">18th April, 2025</option>
                                    <option value="19th April, 2025">19th April, 2025</option>
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple dates</small>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year">
                                    <option value="">All Years</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="cgpa" class="form-label">CGPA</label>
                                <div class="input-group">
                                    <select class="form-select" id="cgpa_operator" name="cgpa_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="cgpa" name="cgpa" placeholder="CGPA"
                                        step="0.01" min="0" max="10">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Status</option>
                                    <option value="Current Student">Current Student</option>
                                    <option value="Alumni">Alumni</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="companies_left" class="form-label">Companies Left</label>
                                <div class="input-group">
                                    <select class="form-select" id="companies_operator" name="companies_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="companies_left" name="companies_left"
                                        placeholder="Number" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="profile_score" class="form-label">Profile Score</label>
                                <div class="input-group">
                                    <select class="form-select" id="score_operator" name="score_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="profile_score" name="profile_score"
                                        placeholder="Score" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="company" class="form-label">Applied to Company</label>
                                <select class="form-select" id="company" name="company">
                                    <option value="">All Companies</option>
                                    {% for company in companies %}
                                    <option value="{{ company.name }}" data-company-id="{{ company.id }}">{{ company.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="job" class="form-label">Applied to Job</label>
                                <select class="form-select" id="job" name="job">
                                    <option value="">All Jobs</option>
                                    {% for job in jobs %}
                                    <option value="{{ job.title }}" data-company-id="{{ job.company.id }}" data-job-id="{{ job.id }}" class="job-option">{{ job.title }} ({{ job.company.name }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="attendance_status" class="form-label">Attendance Status</label>
                                <select class="form-select" id="attendance_status" name="attendance_status">
                                    <option value="">All</option>
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="not_marked">Not Marked</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                                <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Filters -->
                    <div class="active-filters" id="activeFilters"></div>

                    <!-- Message to Filtered Students Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Send Message to Filtered Students</h5>
                        </div>
                        <div class="card-body">
                            <form id="messageForm" class="row g-3" action="{% url 'send_message_to_filtered_students' %}" method="POST">
                                {% csrf_token %}
                                <!-- Hidden fields to pass all current filter values -->
                                <input type="hidden" id="msg_id" name="id">
                                <input type="hidden" id="msg_name" name="name">
                                <input type="hidden" id="msg_email" name="email">
                                <input type="hidden" id="msg_phone" name="phone">
                                <input type="hidden" id="msg_course" name="course">
                                <input type="hidden" id="msg_year" name="year">
                                <input type="hidden" id="msg_cgpa" name="cgpa">
                                <input type="hidden" id="msg_cgpa_operator" name="cgpa_operator">
                                <input type="hidden" id="msg_status" name="status">
                                <input type="hidden" id="msg_companies_left" name="companies_left">
                                <input type="hidden" id="msg_companies_operator" name="companies_operator">
                                <input type="hidden" id="msg_profile_score" name="profile_score">
                                <input type="hidden" id="msg_score_operator" name="score_operator">
                                <input type="hidden" id="msg_company" name="company">
                                <input type="hidden" id="msg_job" name="job">
                                <input type="hidden" id="msg_attendance_status" name="attendance_status">
                                
                                <div class="col-md-12">
                                    <label for="messageSubject" class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="messageSubject" name="subject" placeholder="Message subject..." required>
                                </div>
                                <div class="col-md-12">
                                    <label for="messageContent" class="form-label">Message Content</label>
                                    <textarea class="form-control" id="messageContent" name="content" rows="4" placeholder="Type your message here..." required></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-info" id="sendMessageBtn">
                                        <i class="fas fa-paper-plane me-2"></i>Send Message
                                    </button>
                                    <div class="form-text mt-2">
                                        Message will be sent to all students matching your current filters as both email and notification.
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- DataTable -->
                    <div class="table-responsive mb-4">
                        <table id="dataTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>CGPA</th>
                                    <th>Status</th>
                                    <th>Companies Left</th>
                                    <th>Profile Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="11" class="text-center">Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Export Section -->
                    <div class="card mb-4 export-section">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-file-export me-2"></i>Export Options</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">1. Export Filtered Data</h6>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <button id="filteredExportCSV" class="btn btn-outline-success export-button">
                                            <i class="fas fa-file-csv me-1"></i> CSV
                                        </button>
                                        <button id="filteredExportExcel" class="btn btn-outline-primary export-button">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button id="filteredExportHTML" class="btn btn-outline-info export-button">
                                            <i class="fas fa-file-code me-1"></i> HTML
                                        </button>
                                        <button id="filteredExportPDF" class="btn btn-outline-danger export-button">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">2. Export Student Documents</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button id="exportAllDocuments" class="btn btn-outline-primary export-button">
                                            <i class="fas fa-file-archive me-1"></i> All Documents
                                        </button>
                                        <button id="exportResumes" class="btn btn-outline-secondary export-button">
                                            <i class="fas fa-file-alt me-1"></i> Resumes Only
                                        </button>
                                        <button id="exportMarksheets" class="btn btn-outline-secondary export-button">
                                            <i class="fas fa-file-certificate me-1"></i> Marksheets Only
                                        </button>
                                        <button id="exportProfiles" class="btn btn-outline-secondary export-button">
                                            <i class="fas fa-id-card me-1"></i> Profile Pictures
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">3. Fallback Export Options</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        <a href="{% url 'export_filtered_students_pdf' %}" class="btn btn-outline-danger export-button" download>
                                            <i class="fas fa-file-pdf me-1"></i> Direct PDF Export
                                        </a>
                                        <a href="{% url 'export_all_students' %}?format=csv" class="btn btn-outline-success export-button" download>
                                            <i class="fas fa-download me-1"></i> All Students (CSV)
                                        </a>
                                    </div>
                                    <div class="form-text mt-2">
                                        Use these options if other export methods aren't working
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom export modal for additional options -->
<div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exportOptionsModalLabel">Export Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="mb-3">
                        <label class="form-label">Select Columns to Export</label>
                        <div id="columnCheckboxes" class="row">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="exportTitle" class="form-label">Export Title</label>
                        <input type="text" class="form-control" id="exportTitle" value="Filtered Students Data">
                    </div>
                    <div class="mb-3">
                        <label for="exportFilename" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="exportFilename" value="students_data">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="proceedExport">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Required JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<!-- Select2 JS - Make sure it's loaded before using it -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        console.log("Page ready!");
        
        // Initialize multiple select for interview dates with Select2
        try {
            if ($.fn.select2) {
                $('#interview_date').select2({
                    placeholder: "Select interview dates",
                    allowClear: true,
                    width: '100%'
                });
                
                // Initialize company dropdown with Select2
                $('#company').select2({
                    placeholder: "Select a company",
                    allowClear: true,
                    width: '100%'
                });
                
                // Initialize job dropdown with Select2
                $('#job').select2({
                    placeholder: "Select a job",
                    allowClear: true,
                    width: '100%'
                });
            } else {
                // Fallback to standard multiple select
                $('#interview_date').prop('multiple', true);
            }
        } catch (error) {
            console.error("Error initializing select2:", error);
            $('#interview_date').prop('multiple', true);
        }

        // Initialize DataTable directly with the dedicated JSON endpoint
        console.log("Initializing DataTable with JSON endpoint...");
        $('#loadingOverlay').css('display', 'flex');
        
        try {
            if ($.fn.DataTable && $.fn.DataTable.isDataTable('#dataTable')) {
                $('#dataTable').DataTable().destroy();
            }
            
            if ($.fn.DataTable) {
                $('#dataTable').DataTable({
                    processing: true,
                    serverSide: true,
                    ajax: {
                        url: '/administration/get_filtered_students',
                        type: 'GET',
                        data: function(d) {
                            // Add filter parameters to the request
                            d.id = $('#id').val() || '';
                            d.name = $('#name').val() || '';
                            d.email = $('#email').val() || '';
                            d.phone = $('#phone').val() || '';
                            d.year = $('#year').val() || '';
                            d.cgpa = $('#cgpa').val() || '';
                            d.cgpa_operator = $('#cgpa_operator').val() || '=';
                            d.status = $('#status').val() || '';
                            d.companies_left = $('#companies_left').val() || '';
                            d.companies_operator = $('#companies_operator').val() || '=';
                            d.profile_score = $('#profile_score').val() || '';
                            d.score_operator = $('#score_operator').val() || '=';
                            d.attendance_status = $('#attendance_status').val() || '';
                            
                            // Get selected courses
                            const courses = [];
                            $('.course-checkbox:checked').each(function() {
                                courses.push($(this).val());
                            });
                            d.course = courses;
                            
                            // Get selected companies from both checkbox group and dropdown
                            const companies = [];
                            $('.company-checkbox:checked').each(function() {
                                companies.push($(this).val());
                            });
                            
                            // Add company from dropdown if selected
                            const companyDropdownVal = $('#company').val();
                            if (companyDropdownVal) {
                                const companyId = $('#company option:selected').data('company-id');
                                if (companyId && !companies.includes(companyId.toString())) {
                                    companies.push(companyId.toString());
                                }
                            }
                            d.companies = companies;
                            
                            // Get selected jobs from both checkbox group and dropdown
                            const jobs = [];
                            $('.job-checkbox:checked').each(function() {
                                jobs.push($(this).val());
                            });
                            
                            // Add job from dropdown if selected
                            const jobDropdownVal = $('#job').val();
                            if (jobDropdownVal) {
                                const jobId = $('#job option:selected').data('job-id');
                                if (jobId && !jobs.includes(jobId.toString())) {
                                    jobs.push(jobId.toString());
                                }
                            }
                            d.jobs = jobs;
                            
                            // Get selected interview dates
                            d.interview_date = $('#interview_date').val() || [];
                            
                            // Log the filter data for debugging
                            console.log("Filter data being sent:", {
                                companies: d.companies, 
                                jobs: d.jobs, 
                                interviewDates: d.interview_date
                            });
                            
                            return d;
                        },
                        error: function(xhr, error, thrown) {
                            console.error("DataTables AJAX error:", error, thrown);
                            $('#loadingOverlay').hide();
                            $('#dataTable tbody').html('<tr><td colspan="11" class="text-center">Error loading data: ' + thrown + '</td></tr>');
                        }
                    },
                    columns: [
                        { data: 'id' },
                        { data: 'name' },
                        { data: 'email' },
                        { data: 'phone' },
                        { data: 'course' },
                        { data: 'year' },
                        { data: 'cgpa' },
                        { data: 'status' },
                        { data: 'companies_left' },
                        { data: 'profile_score' },
                        { data: 'actions' }
                    ],
                    pageLength: 10,
                    responsive: true,
                    language: {
                        processing: "Loading data...",
                        zeroRecords: "No matching records found",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        infoFiltered: "(filtered from _MAX_ total entries)"
                    },
                    initComplete: function() {
                        $('#loadingOverlay').hide();
                        console.log("DataTable initialization complete");
                    }
                });
            } else {
                console.error("DataTables plugin not available");
                $('#loadingOverlay').hide();
                $('#dataTable tbody').html('<tr><td colspan="11" class="text-center">DataTables plugin not available. Please refresh the page.</td></tr>');
            }
        } catch (error) {
            console.error("Error initializing DataTable:", error);
            $('#loadingOverlay').hide();
            $('#dataTable tbody').html('<tr><td colspan="11" class="text-center">Error loading data: ' + error.message + '</td></tr>');
        }
        
        // Handle form submission
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            console.log("Filter form submitted");
            $('#loadingOverlay').css('display', 'flex');
            
            // Get form values for active filters display
            const formData = {
                id: $('#id').val(),
                name: $('#name').val(),
                email: $('#email').val(),
                phone: $('#phone').val(),
                year: $('#year').val(),
                cgpa: $('#cgpa').val(),
                cgpa_operator: $('#cgpa_operator').val(),
                status: $('#status').val(),
                companies_left: $('#companies_left').val(),
                companies_operator: $('#companies_operator').val(),
                profile_score: $('#profile_score').val(),
                score_operator: $('#score_operator').val(),
                attendance_status: $('#attendance_status').val()
            };
            
            // Get courses for display
            const courses = [];
            $('.course-checkbox:checked').each(function() {
                courses.push($(this).val());
            });
            
            // Update active filters display
            updateActiveFilters(formData, courses);
            
            // Log all filter data for debugging
            console.log("Filter submission:", {
                formData: formData,
                courses: courses,
                companies: $('.company-checkbox:checked').map(function() { return $(this).val(); }).get(),
                company: $('#company').val(),
                jobs: $('.job-checkbox:checked').map(function() { return $(this).val(); }).get(),
                job: $('#job').val(),
                interviewDates: $('#interview_date').val()
            });
            
            // Reload the DataTable with the new filters
            $('#dataTable').DataTable().ajax.reload();
            
            $('#loadingOverlay').hide();
        });
        
        // Reset filters
        $('#resetFilters').on('click', function() {
            $('#filterForm')[0].reset();
            $('.course-checkbox').prop('checked', false);
            $('.company-checkbox').prop('checked', false);
            $('.job-checkbox').prop('checked', false);
            $('.job-option').hide();
            
            if (typeof $.fn.select2 === 'function') {
                $('#interview_date').val(null).trigger('change');
            }
            
            // Clear active filters
            $('#activeFilters').empty().html('<span class="text-muted">No active filters</span>');
            
            // Reset DataTable and reload with no filters
            const table = $('#dataTable').DataTable();
                        table.ajax.reload();
        });
    });
    
    function updateActiveFilters(formData, courses) {
        const activeFilters = [];
        
        if (formData.id) activeFilters.push(`ID: ${formData.id}`);
        if (formData.name) activeFilters.push(`Name: ${formData.name}`);
        if (formData.email) activeFilters.push(`Email: ${formData.email}`);
        if (formData.phone) activeFilters.push(`Phone: ${formData.phone}`);
        if (formData.year) activeFilters.push(`Year: ${formData.year}`);
        if (formData.cgpa) activeFilters.push(`CGPA ${formData.cgpa_operator} ${formData.cgpa}`);
        if (formData.status) activeFilters.push(`Status: ${formData.status}`);
        if (formData.companies_left) activeFilters.push(`Companies Left ${formData.companies_operator} ${formData.companies_left}`);
        if (formData.profile_score) activeFilters.push(`Profile Score ${formData.score_operator} ${formData.profile_score}`);
        if (formData.attendance_status) activeFilters.push(`Attendance: ${formData.attendance_status}`);
        
        if (courses && courses.length > 0) {
            activeFilters.push(`Courses: ${courses.join(', ')}`);
        }
        
        // Add selected companies from checkboxes
        const selectedCompanies = [];
        $('.company-checkbox:checked').each(function() {
            selectedCompanies.push($(this).next('label').text());
        });
        if (selectedCompanies.length > 0) {
            activeFilters.push(`Companies: ${selectedCompanies.join(', ')}`);
        }
        
        // Add company from dropdown
        const companyDropdownVal = $('#company').val();
        if (companyDropdownVal) {
            activeFilters.push(`Company: ${companyDropdownVal}`);
        }
        
        // Add selected jobs from checkboxes
        const selectedJobs = [];
        $('.job-checkbox:checked').each(function() {
            selectedJobs.push($(this).next('label').text());
        });
        if (selectedJobs.length > 0) {
            activeFilters.push(`Jobs: ${selectedJobs.join(', ')}`);
        }
        
        // Add job from dropdown
        const jobDropdownVal = $('#job').val();
        if (jobDropdownVal) {
            activeFilters.push(`Job: ${jobDropdownVal}`);
        }
        
        // Add interview dates
        const interviewDates = $('#interview_date').val();
        if (interviewDates && interviewDates.length > 0) {
            activeFilters.push(`Interview Dates: ${interviewDates.join(', ')}`);
        }
        
        const activeFiltersHtml = activeFilters.map(filter => 
            `<span class="badge bg-primary filter-badge">${filter}</span>`
        ).join(' ');
        
        $('#activeFilters').html(activeFiltersHtml || '<span class="text-muted">No active filters</span>');
    }
</script>

<script>
$(document).ready(function() {
    // Define getCurrentFilters at the global scope
    function getCurrentFilters() {
        return {
            id: $('#id').val() || '',
            name: $('#name').val() || '',
            email: $('#email').val() || '',
            phone: $('#phone').val() || '',
            course: $('#course').val() || '',
            year: $('#year').val() || '',
            cgpa: $('#cgpa').val() || '',
            cgpa_operator: $('#cgpa_operator').val() || '=',
            status: $('#status').val() || '',
            companies_left: $('#companies_left').val() || '',
            companies_operator: $('#companies_operator').val() || '=',
            profile_score: $('#profile_score').val() || '',
            score_operator: $('#score_operator').val() || '=',
            company: $('#company').val() || '',
            job: $('#job').val() || '',
            attendance_status: $('#attendance_status').val() || ''
        };
    }

    // Function to create export URL with filter parameters
    function createFilteredExportUrl(format) {
        // Start with the base URL
        let url = '/administration/export_filtered_students?format=' + format;
        
        // Get form data to capture all inputs including checkboxes
        const formData = new FormData(document.getElementById('filterForm'));
        
        // Get selected courses (checkboxes)
        const selectedCourses = [];
        $('.course-checkbox:checked').each(function() {
            selectedCourses.push($(this).val());
        });
        
        // Get selected companies (checkboxes)
        const selectedCompanies = [];
        $('.company-checkbox:checked').each(function() {
            selectedCompanies.push($(this).val());
        });
        
        // Get selected jobs (checkboxes)
        const selectedJobs = [];
        $('.job-checkbox:checked').each(function() {
            selectedJobs.push($(this).val());
        });
        
        // Add basic filters
        const filters = getCurrentFilters();
        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                url += '&' + key + '=' + encodeURIComponent(filters[key]);
            }
        });
        
        // Add multiple selection filters
        if (selectedCourses.length > 0) {
            selectedCourses.forEach(course => {
                url += '&course[]=' + encodeURIComponent(course);
            });
        }
        
        if (selectedCompanies.length > 0) {
            selectedCompanies.forEach(company => {
                url += '&companies[]=' + encodeURIComponent(company);
            });
        }
        
        if (selectedJobs.length > 0) {
            selectedJobs.forEach(job => {
                url += '&jobs[]=' + encodeURIComponent(job);
            });
        }
        
        console.log("Export URL:", url);
        return url;
    }

    // Function for reliable downloads via iframe
    function downloadViaIframe(url) {
        $('#loadingOverlay').css('display', 'flex');
        
        try {
            // Create temporary iframe for download
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Set iframe source to our export URL
            iframe.src = url;
            
            // Set a timeout to remove the iframe and hide loading overlay
            setTimeout(function() {
                $('#loadingOverlay').hide();
                setTimeout(function() {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 5000);
            }, 3000);
        } catch (e) {
            console.error("Download error:", e);
            $('#loadingOverlay').hide();
            alert("Export failed: " + e.message);
        }
    }

    // Function to export documents based on type
    function exportDocuments(exportType) {
        $('#loadingOverlay').css('display', 'flex');
        
        try {
            // Create document export URL with current filters
            let url = '/administration/export_filtered_documents?export_type=' + exportType;
            
            // Add all current filter parameters
            const filters = getCurrentFilters();
            Object.keys(filters).forEach(key => {
                if (filters[key]) {
                    url += '&' + key + '=' + encodeURIComponent(filters[key]);
                }
            });
            
            console.log("Document export URL:", url);
            
            // Create temporary iframe for download
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Set iframe source to export URL
            iframe.src = url;
            
            // Set timeout to remove iframe and hide loading overlay
            setTimeout(function() {
                $('#loadingOverlay').hide();
                setTimeout(function() {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 5000);
            }, 3000);
        } catch (e) {
            console.error("Document export error:", e);
            $('#loadingOverlay').hide();
            alert("Export failed: " + e.message);
        }
    }

    // Setup export button click handlers when document is ready
    console.log("Setting up export handlers");
    
    $('#filteredExportCSV').click(function(e) {
        e.preventDefault();
        console.log("CSV export clicked");
        downloadViaIframe(createFilteredExportUrl('csv'));
    });
    
    $('#filteredExportExcel').click(function(e) {
        e.preventDefault();
        console.log("Excel export clicked");
        downloadViaIframe(createFilteredExportUrl('excel'));
    });
    
    $('#filteredExportHTML').click(function(e) {
        e.preventDefault();
        console.log("HTML export clicked");
        downloadViaIframe(createFilteredExportUrl('html'));
    });
    
    $('#filteredExportPDF').click(function(e) {
        e.preventDefault();
        console.log("PDF export clicked");
        // Using HTML format for PDF is more reliable
        downloadViaIframe(createFilteredExportUrl('html'));
    });
    
    // Document export handlers
    $('#exportAllDocuments').click(function(e) {
        e.preventDefault();
        console.log("All documents export clicked");
        exportDocuments('all');
    });
    
    $('#exportResumes').click(function(e) {
        e.preventDefault();
        console.log("Resumes export clicked");
        exportDocuments('resume');
    });
    
    $('#exportMarksheets').click(function(e) {
        e.preventDefault();
        console.log("Marksheets export clicked");
        exportDocuments('marksheets');
    });
    
    $('#exportProfiles').click(function(e) {
        e.preventDefault();
        console.log("Profiles export clicked");
        exportDocuments('profile');
    });
});
</script>

<script>
    // Function to sync main filters to direct form
    function syncMainFiltersToDirectForm() {
        if ($('#syncFilters').prop('checked')) {
            const directForm = $('form[action="/administration/export_filtered_students"]');
            
            // Clear any existing hidden fields
            directForm.find('input[type="hidden"]:not([name="format"])').remove();
            
            // Add all filter values as hidden fields
            $('#filterForm input, #filterForm select').each(function() {
                const input = $(this);
                const name = input.attr('name');
                const value = input.val();
                
                if (name && value) {
                    directForm.append(`<input type="hidden" name="${name}" value="${value}">`);
                }
            });
            
            // Update the display of active filters
            const filterTexts = [];
            $('#activeFilters .filter-badge').each(function() {
                filterTexts.push($(this).text());
            });
            
            $('#directFormFilters').text(filterTexts.join(', ') || 'No filters set');
        }
    }
    
    // Update filters when the sync checkbox changes
    $('#syncFilters').on('change', syncMainFiltersToDirectForm);
    
    // Update filters when the main form changes
    $('#filterForm').on('submit', syncMainFiltersToDirectForm);
    $('#filterForm input, #filterForm select').on('change keyup', function() {
        // Add debounce for performance
        clearTimeout(window.filterSyncTimeout);
        window.filterSyncTimeout = setTimeout(syncMainFiltersToDirectForm, 500);
    });
    
    // Sync filters once on page load
    $(document).ready(function() {
        setTimeout(syncMainFiltersToDirectForm, 1000);
    });
</script>

<script>
    // Function to update the hidden input fields in the message form with current filter values
    function updateMessageFormFields() {
        // Get all filter values
        const filters = {
            id: $('#id').val() || '',
            name: $('#name').val() || '',
            email: $('#email').val() || '',
            phone: $('#phone').val() || '',
            course: $('#course').val() || '',
            year: $('#year').val() || '',
            cgpa: $('#cgpa').val() || '',
            cgpa_operator: $('#cgpa_operator').val() || '=',
            status: $('#status').val() || '',
            companies_left: $('#companies_left').val() || '',
            companies_operator: $('#companies_operator').val() || '=',
            profile_score: $('#profile_score').val() || '',
            score_operator: $('#score_operator').val() || '=',
            company: $('#company').val() || '',
            job: $('#job').val() || '',
            attendance_status: $('#attendance_status').val() || ''
        };
        
        console.log("Updating message form with filters:", filters);
        
        // Update hidden fields in message form
        $('#msg_id').val(filters.id);
        $('#msg_name').val(filters.name);
        $('#msg_email').val(filters.email);
        $('#msg_phone').val(filters.phone);
        $('#msg_course').val(filters.course);
        $('#msg_year').val(filters.year);
        $('#msg_cgpa').val(filters.cgpa);
        $('#msg_cgpa_operator').val(filters.cgpa_operator);
        $('#msg_status').val(filters.status);
        $('#msg_companies_left').val(filters.companies_left);
        $('#msg_companies_operator').val(filters.companies_operator);
        $('#msg_profile_score').val(filters.profile_score);
        $('#msg_score_operator').val(filters.score_operator);
        $('#msg_company').val(filters.company);
        $('#msg_job').val(filters.job);
        $('#msg_attendance_status').val(filters.attendance_status);
    }
    
    // Update message form fields when filter form changes
    $('#filterForm input, #filterForm select').on('change keyup', function() {
        updateMessageFormFields();
    });
    
    // Update message form fields when filter form is submitted
    $('#filterForm').on('submit', function() {
        updateMessageFormFields();
    });
    
    // Update message form fields on page load
    $(document).ready(function() {
        updateMessageFormFields();
        
        // Force update message form immediately before submission
        $('#messageForm').on('submit', function(e) {
            updateMessageFormFields();
            // Debug output
            console.log("Message form submitted with params:", {
                id: $('#msg_id').val(),
                name: $('#msg_name').val(), 
                email: $('#msg_email').val(),
                companies_left: $('#msg_companies_left').val(),
                companies_operator: $('#msg_companies_operator').val(),
                company: $('#msg_company').val(),
                job: $('#msg_job').val(),
                attendance_status: $('#msg_attendance_status').val()
            });
        });
    });
</script>

<script>
    // Initialize company-job filter relationship
    $(document).ready(function() {
        // Function to filter jobs based on selected company
        function filterJobsByCompany() {
            const selectedCompany = $('#company');
            const selectedCompanyId = selectedCompany.find('option:selected').data('company-id');
            const selectedCompanyName = selectedCompany.val();
            const jobSelect = $('#job');
            
            // Reset job dropdown
            jobSelect.val(null).trigger('change');
            
            if (selectedCompanyName) {
                // Filter job dropdown options
                $('#job option').each(function() {
                    const jobCompanyId = $(this).data('company-id');
                    // If it's the default "All Jobs" option or matches the selected company, show it
                    if (!$(this).val() || jobCompanyId == selectedCompanyId) {
                        $(this).prop('disabled', false);
                        $(this).show();
                    } else {
                        $(this).prop('disabled', true);
                        $(this).hide();
                    }
                });
                
                // Refresh Select2 to reflect changes
                if ($.fn.select2) {
                    $('#job').select2('destroy').select2({
                        placeholder: "Select a job",
                        allowClear: true,
                        width: '100%'
                    });
                }
                
                // If no jobs found for this company, add a disabled option with message
                const visibleOptions = $('#job option:not(:disabled)').length;
                if (visibleOptions <= 1) { // 1 is for the default empty option
                    if ($('#no-jobs-message').length === 0) {
                        jobSelect.append('<option id="no-jobs-message" disabled>No jobs available for this company</option>');
                        
                        // Refresh Select2 again
                        if ($.fn.select2) {
                            $('#job').select2('destroy').select2({
                                placeholder: "Select a job",
                                allowClear: true,
                                width: '100%'
                            });
                        }
                    }
                } else {
                    // Remove message if it exists
                    $('#no-jobs-message').remove();
                }
            } else {
                // If no company selected, enable all job options
                $('#job option').prop('disabled', false).show();
                $('#no-jobs-message').remove();
                
                // Refresh Select2
                if ($.fn.select2) {
                    $('#job').select2('destroy').select2({
                        placeholder: "Select a job",
                        allowClear: true,
                        width: '100%'
                    });
                }
            }
        }
        
        // Handle company selection change
        $('#company').on('change', function() {
            filterJobsByCompany();
            
            // Automatically refresh the table when company changes
            if ($.fn.DataTable) {
                $('#dataTable').DataTable().ajax.reload();
            }
        });
        
        // Handle job selection change
        $('#job').on('change', function() {
            // Automatically refresh the table when job changes
            if ($.fn.DataTable) {
        $('#dataTable').DataTable().ajax.reload();
            }
        });
        
        // Handle interview date selection change
        $('#interview_date').on('change', function() {
            // Automatically refresh the table when interview dates change
            if ($.fn.DataTable) {
                $('#dataTable').DataTable().ajax.reload();
            }
        });
        
        // Handle form reset
        $('#resetFilters').on('click', function() {
            // Reset job dropdown and show all options
            $('#job').val('').trigger('change');
            $('#company').val('').trigger('change');
            $('#interview_date').val(null).trigger('change');
            $('#no-jobs-message').remove();
            
            // Ensure all job options are visible
            $('#job option').prop('disabled', false).show();
            
            // Refresh Select2
            if ($.fn.select2) {
                $('#job').select2('destroy').select2({
                    placeholder: "Select a job",
                    allowClear: true,
                    width: '100%'
                });
            }
        });
        
        // Initial filtering on page load
        filterJobsByCompany();
});
</script>

<script>
// Handle company and job checkboxes for advanced filtering
    $(document).ready(function() {
    // Function to update active filters display when checkboxes change
    function updateActiveFiltersDisplay() {
        const activeFilters = [];
        
        // Add selected courses
        const selectedCourses = $('.course-checkbox:checked').map(function() {
            return $(this).next('label').text();
        }).get();
        if (selectedCourses.length > 0) {
            activeFilters.push(`Courses: ${selectedCourses.join(', ')}`);
        }
        
        // Add selected companies
        const selectedCompanies = $('.company-checkbox:checked').map(function() {
            return $(this).next('label').text();
        }).get();
        if (selectedCompanies.length > 0) {
            activeFilters.push(`Companies: ${selectedCompanies.join(', ')}`);
        }
        
        // Add company from dropdown if selected
        const companyDropdown = $('#company').val();
        if (companyDropdown) {
            activeFilters.push(`Company: ${companyDropdown}`);
        }
        
        // Add selected jobs
        const selectedJobs = $('.job-checkbox:checked').map(function() {
            return $(this).next('label').text();
        }).get();
        if (selectedJobs.length > 0) {
            activeFilters.push(`Jobs: ${selectedJobs.join(', ')}`);
        }
        
        // Add job from dropdown if selected
        const jobDropdown = $('#job').val();
        if (jobDropdown) {
            activeFilters.push(`Job: ${jobDropdown}`);
        }
        
        // Add selected interview dates
        const selectedDates = $('#interview_date').val();
        if (selectedDates && selectedDates.length > 0) {
            activeFilters.push(`Interview Dates: ${selectedDates.join(', ')}`);
        }
        
        // Update the display
        const activeFiltersHtml = activeFilters.map(filter => 
            `<span class="badge bg-primary filter-badge">${filter}</span>`
        ).join(' ');
        
        $('#activeFilters').html(activeFiltersHtml || '<span class="text-muted">No active filters</span>');
    }
    
    // Update active filters when checkboxes change
    $('.course-checkbox, .company-checkbox, .job-checkbox').on('change', function() {
        updateActiveFiltersDisplay();
        
        // Reload the table when checkboxes change
        if ($.fn.DataTable) {
            $('#dataTable').DataTable().ajax.reload();
        }
    });
    
    // Update active filters when select dropdowns change
    $('#company, #job, #interview_date').on('change', function() {
        updateActiveFiltersDisplay();
    });
    
    // Initial update of active filters
    updateActiveFiltersDisplay();
    
    // When company checkboxes change, filter available jobs
    $('.company-checkbox').on('change', function() {
        const selectedCompanies = $('.company-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
        
        if (selectedCompanies.length === 0) {
            // If no companies selected, hide all jobs
            $('.job-option').hide();
            $('.job-checkbox').prop('checked', false);
        } else {
            // Show jobs for selected companies
                $('.job-option').each(function() {
                const companyId = $(this).data('company-id');
                if (selectedCompanies.includes(companyId.toString())) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    $(this).find('.job-checkbox').prop('checked', false);
                }
            });
        }
        
        // Update active filters display
        updateActiveFiltersDisplay();
        });
    });
</script>
{% endblock %}