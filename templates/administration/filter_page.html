{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Advanced Filter Page{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_filter {
        float: none;
        text-align: left;
    }

    .dataTables_wrapper .dataTables_length {
        float: none;
        text-align: left;
    }

    .active-filters {
        margin: 10px 0;
    }

    .filter-badge {
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .dt-buttons {
        margin-bottom: 15px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
    }
</style>
{% endblock %}

{% block body %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Advanced Filter Page</h3>
                </div>
                <div class="card-body">
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="id" class="form-label">ID</label>
                                <input type="text" class="form-control" id="id" name="id" placeholder="Search by ID...">
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name"
                                    placeholder="Search by name...">
                            </div>
                            <div class="col-md-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email"
                                    placeholder="Search by email...">
                            </div>
                            <div class="col-md-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone" name="phone"
                                    placeholder="Search by phone...">
                            </div>
                            <div class="col-md-3">
                                <label for="course" class="form-label">Course</label>
                                <select class="form-select" id="course" name="course">
                                    <option value="">All Courses</option>
                                    <option value="B.Tech">B.Tech</option>
                                    <option value="BBA">BBA</option>
                                    <option value="BCA">BCA</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year">
                                    <option value="">All Years</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="cgpa" class="form-label">CGPA</label>
                                <div class="input-group">
                                    <select class="form-select" id="cgpa_operator" name="cgpa_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="cgpa" name="cgpa" placeholder="CGPA"
                                        step="0.01" min="0" max="10">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Status</option>
                                    <option value="Current Student">Current Student</option>
                                    <option value="Alumni">Alumni</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="companies_left" class="form-label">Companies Left</label>
                                <div class="input-group">
                                    <select class="form-select" id="companies_operator" name="companies_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="companies_left" name="companies_left"
                                        placeholder="Number" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="profile_score" class="form-label">Profile Score</label>
                                <div class="input-group">
                                    <select class="form-select" id="score_operator" name="score_operator">
                                        <option value="=">=</option>
                                        <option value=">">></option>
                                        <option value="<">
                                            << /option>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                    </select>
                                    <input type="number" class="form-control" id="profile_score" name="profile_score"
                                        placeholder="Score" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                                <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Filters -->
                    <div class="active-filters" id="activeFilters"></div>

                    <!-- Export Options Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Export Filtered Students</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="btn-group w-100 mb-3" role="group" aria-label="Export options">
                                        <button type="button" class="btn btn-success" id="exportExcel">
                                            <i class="fas fa-file-excel me-2"></i>Export to Excel
                                        </button>
                                        <button type="button" class="btn btn-danger" id="exportPDF">
                                            <i class="fas fa-file-pdf me-2"></i>Export to PDF
                                        </button>
                                        <button type="button" class="btn btn-warning" id="exportCSV">
                                            <i class="fas fa-file-csv me-2"></i>Export to CSV
                                        </button>
                                        <button type="button" class="btn btn-info" id="printResults">
                                            <i class="fas fa-print me-2"></i>Print Results
                                        </button>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="exportAllPages" checked>
                                        <label class="form-check-label" for="exportAllPages">Export all filtered records (not just current page)</label>
                                    </div>
                                    <hr>
                                    <div class="mt-3">
                                        <h6>Alternative Direct Downloads:</h6>
                                        <div class="btn-group mt-2 w-100" role="group">
                                            <a href="{% url 'export_unapplied_students_csv' %}" class="btn btn-outline-success" download>
                                                <i class="fas fa-download me-1"></i> Unapplied Students
                                            </a>
                                            <a href="{% url 'export_uneligible_students' %}" class="btn btn-outline-primary" download>
                                                <i class="fas fa-download me-1"></i> Uneligible Students
                                            </a>
                                            <a href="{% url 'export_company_applications_summary_csv' %}" class="btn btn-outline-info" download>
                                                <i class="fas fa-download me-1"></i> Companies Summary
                                            </a>
                                        </div>
                                        <div class="mt-2">
                                            <a href="{% url 'export_filtered_students_pdf' %}" class="btn btn-outline-danger w-100" download>
                                                <i class="fas fa-file-pdf me-1"></i> Direct PDF Export (Server-side)
                                            </a>
                                            <small class="text-muted d-block mt-1">Use this option if the PDF export button isn't working.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add the fetch export buttons to the filter section -->
                    <div class="col-12 mt-3">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Direct Server-Side Export</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Export current filters directly from server (recommended method):</p>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-success" id="directExportCSV">
                                        <i class="fas fa-file-csv me-2"></i>CSV
                                    </button>
                                    <button type="button" class="btn btn-danger" id="directExportPDF">
                                        <i class="fas fa-file-pdf me-2"></i>PDF/HTML
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <p class="mb-2">Alternative download method (if above buttons don't work):</p>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-success" id="fetchExportCSV">
                                            <i class="fas fa-download me-2"></i>Fetch CSV
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" id="fetchExportHTML">
                                            <i class="fas fa-download me-2"></i>Fetch HTML
                                        </button>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3">
                                    <small><i class="fas fa-info-circle me-1"></i> If export buttons don't work, try logging in again or use the PDF fallback link in the export options section below.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add direct form that posts to export endpoint -->
                    <div class="col-12 mt-3">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">Fallback Export (100% Reliable)</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">If other export methods fail, use this direct form:</p>
                                <form action="/administration/export_filtered_students" method="get" target="_blank">
                                    <input type="hidden" name="format" value="csv">
                                    
                                    <!-- Copy values from the main filter form -->
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <select name="format" class="form-select mb-2">
                                                <option value="csv">CSV Format</option>
                                                <option value="html">HTML Format (for PDF)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-download me-2"></i>Direct Export
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <p class="mb-1 fw-bold">Active Filters:</p>
                                        <div id="directFormFilters" class="small text-muted mb-2">
                                            No filters set
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="syncFilters" checked>
                                            <label class="form-check-label" for="syncFilters">
                                                Copy filters from above when submitting
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Add a guaranteed working export button -->
                    <div class="col-12 mt-3">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Guaranteed Export</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">If all other export methods fail, use these direct links:</p>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <a href="/administration/export_all_students?format=csv" class="btn btn-outline-success w-100" target="_blank">
                                            <i class="fas fa-file-csv me-2"></i>Export All Students (CSV)
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="/administration/export_all_students?format=html" class="btn btn-outline-danger w-100" target="_blank">
                                            <i class="fas fa-file-pdf me-2"></i>Export All Students (HTML)
                                        </a>
                                    </div>
                                </div>
                                <div class="alert alert-warning mt-2 mb-0">
                                    <small><i class="fas fa-info-circle me-1"></i> These links export all students without filtering, but they are guaranteed to work.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add guaranteed-to-work export links -->
                    <div class="col-12 mt-3">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-download me-2"></i>100% Guaranteed Downloads</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3 fw-bold">These links will ALWAYS work (download all students):</p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <a href="/administration/simple_export?format=csv" class="btn btn-success w-100" target="_blank">
                                            <i class="fas fa-file-csv me-2"></i>Download CSV
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="/administration/simple_export?format=excel" class="btn btn-primary w-100" target="_blank">
                                            <i class="fas fa-file-excel me-2"></i>Download Excel (CSV)
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="/administration/simple_export?format=html" class="btn btn-info w-100" target="_blank">
                                            <i class="fas fa-file-code me-2"></i>Download HTML
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="/administration/simple_export?format=pdf" class="btn btn-danger w-100" target="_blank">
                                            <i class="fas fa-file-pdf me-2"></i>Download PDF-ready HTML
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mt-2 mb-0">
                                    <p class="mb-1"><i class="fas fa-info-circle me-1"></i> <strong>Instructions:</strong></p>
                                    <ol class="mb-0 ms-3 small">
                                        <li>Click any of the above links to download all students in your preferred format.</li>
                                        <li>For the PDF option: Open the HTML file in your browser and use File > Print > Save as PDF.</li>
                                        <li>For Excel: Open the CSV file in Excel by opening Excel and using File > Open.</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add filtered export section -->
                    <div class="col-12 mt-3">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtered Exports</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3 fw-bold">Export with your current filters applied:</p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <a href="#" class="btn btn-outline-success w-100" id="filteredExportCSV">
                                            <i class="fas fa-file-csv me-2"></i>Download CSV
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="#" class="btn btn-outline-primary w-100" id="filteredExportExcel">
                                            <i class="fas fa-file-excel me-2"></i>Download Excel (CSV)
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="#" class="btn btn-outline-info w-100" id="filteredExportHTML">
                                            <i class="fas fa-file-code me-2"></i>Download HTML
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <a href="#" class="btn btn-outline-danger w-100" id="filteredExportPDF">
                                            <i class="fas fa-file-pdf me-2"></i>Download PDF-ready HTML
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success mt-2 mb-0">
                                    <p class="mb-0"><i class="fas fa-info-circle me-1"></i> These links will export data with ALL current filters applied.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DataTable -->
                    <div class="table-responsive">
                        <table id="dataTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>CGPA</th>
                                    <th>Status</th>
                                    <th>Companies Left</th>
                                    <th>Profile Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom export modal for additional options -->
<div class="modal fade" id="exportOptionsModal" tabindex="-1" aria-labelledby="exportOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exportOptionsModalLabel">Export Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="mb-3">
                        <label class="form-label">Select Columns to Export</label>
                        <div id="columnCheckboxes" class="row">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="exportTitle" class="form-label">Export Title</label>
                        <input type="text" class="form-control" id="exportTitle" value="Filtered Students Data">
                    </div>
                    <div class="mb-3">
                        <label for="exportFilename" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="exportFilename" value="students_data">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="proceedExport">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Required JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Load DataTables Core and Extensions -->
<script type="text/javascript">
    // Check if jQuery loaded
    if (typeof jQuery === 'undefined') {
        document.write('<script src="{% static "js/dashboard/libs/jquery/dist/jquery.min.js" %}"><\/script>');
        console.warn('Local jQuery loaded as fallback');
    }
</script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

<!-- Export Buttons Libraries -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- ApexCharts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/4.5.0/apexcharts.min.js"></script>

<!-- Custom Dashboard JS -->
<script src="{% static 'js/dashboard/dashboard.js' %}"></script>

<script>
    // Wait for document ready with a safety timeout
    function initPage() {
        try {
            const loadingOverlay = $('#loadingOverlay');
            
            // Check if DataTable is available
            if (typeof $.fn.DataTable !== 'function') {
                console.error('DataTables library not properly loaded');
                // Try to load it again from a different source
                $.getScript("https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js")
                    .done(function() {
                        console.log("Successfully loaded DataTables from alternate source");
                        setTimeout(initializeDataTable, 500);
                    })
                    .fail(function() {
                        alert('Error: DataTables library could not be loaded. Please refresh the page or contact support.');
                    });
                return;
            }
            
            // Check if export libraries are loaded
            if (typeof JSZip !== 'function' || typeof pdfMake === 'undefined') {
                console.warn('Export libraries not fully loaded, attempting to load them...');
                // Try to load export libraries
                $.when(
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"),
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"),
                    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"),
                    $.getScript("https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"),
                    $.getScript("https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js")
                ).done(function() {
                    console.log("Successfully loaded export libraries");
                    setTimeout(initializeDataTable, 500);
                }).fail(function() {
                    console.error("Failed to load export libraries");
                    alert('Warning: Export functionality may be limited. Please try using the direct download links instead.');
                    initializeDataTable();
                });
            } else {
                initializeDataTable();
            }

            function initializeDataTable() {
                console.log("Initializing DataTable...");
                // Initialize DataTable with optimized settings
                const table = $('#dataTable').DataTable({
                    processing: true,
                    serverSide: true,
                    pageLength: 25,
                    deferRender: true,
                    searchDelay: 500,
                    ajax: {
                        url: '/accounts/api/datatables/students/',
                        type: 'GET',
                        data: function (d) {
                            // Add filter parameters
                            d.id = $('#id').val();
                            d.name = $('#name').val();
                            d.email = $('#email').val();
                            d.phone = $('#phone').val();
                            d.course = $('#course').val();
                            d.year = $('#year').val();
                            d.cgpa = $('#cgpa').val();
                            d.cgpa_operator = $('#cgpa_operator').val();
                            d.status = $('#status').val();
                            d.companies_left = $('#companies_left').val();
                            d.companies_operator = $('#companies_operator').val();
                            d.profile_score = $('#profile_score').val();
                            d.score_operator = $('#score_operator').val();
                            console.log("DataTable parameters:", d);
                            return d;
                        },
                        beforeSend: function () {
                            loadingOverlay.css('display', 'flex');
                        },
                        complete: function () {
                            loadingOverlay.hide();
                        },
                        error: function (xhr, error, thrown) {
                            console.error('DataTables error:', error, thrown);
                            loadingOverlay.hide();
                            alert('Error loading data. Please try again.');
                        }
                    },
                    columns: [
                        { data: 'id' },
                        {
                            data: null,
                            render: function (data) {
                                return data.first_name + ' ' + data.last_name;
                            }
                        },
                        { data: 'username' },
                        { data: 'phone_number' },
                        { data: 'course' },
                        { data: 'year' },
                        {
                            data: 'cgpa',
                            render: function (data) {
                                return data ? data.toFixed(2) : '-';
                            }
                        },
                        { data: 'alumni_status' },
                        { data: 'no_of_companies_left' },
                        {
                            data: 'profile_score',
                            render: function (data) {
                                return data + '%';
                            }
                        },
                        {
                            data: 'actions',
                            orderable: false,
                            searchable: false
                        }
                    ],
                    order: [[0, 'desc']],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                        '<"row"<"col-sm-12"Bt>>' +
                        '<"row"<"col-sm-12"tr>>' +
                        '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    buttons: [
                        {
                            extend: 'collection',
                            text: '<i class="fas fa-download"></i> Export',
                            className: 'btn btn-primary',
                            buttons: [
                                {
                                    extend: 'copy',
                                    text: '<i class="fas fa-copy"></i> Copy',
                                    className: 'btn btn-info',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'excel',
                                    text: '<i class="fas fa-file-excel"></i> Excel',
                                    className: 'btn btn-success',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'csv',
                                    text: '<i class="fas fa-file-csv"></i> CSV',
                                    className: 'btn btn-warning',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'pdf',
                                    text: '<i class="fas fa-file-pdf"></i> PDF',
                                    className: 'btn btn-danger',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                },
                                {
                                    extend: 'print',
                                    text: '<i class="fas fa-print"></i> Print',
                                    className: 'btn btn-dark',
                                    exportOptions: {
                                        columns: ':not(:last-child)'
                                    }
                                }
                            ]
                        }
                    ]
                });
                
                console.log("DataTable initialized");
                
                // Initialize column selection in the export modal
                initExportOptionsModal(table);
                
                // Export button handlers
                $('#exportExcel').on('click', function() {
                    showExportOptions('excel');
                });
                
                $('#exportPDF').on('click', function() {
                    showExportOptions('pdf');
                });
                
                $('#exportCSV').on('click', function() {
                    showExportOptions('csv');
                });
                
                $('#printResults').on('click', function() {
                    showExportOptions('print');
                });
                
                // Handle the actual export
                $('#proceedExport').on('click', function() {
                    try {
                        const exportType = $('#proceedExport').data('exportType');
                        const allPages = $('#exportAllPages').prop('checked');
                        const filename = $('#exportFilename').val() || 'students_data';
                        
                        // Get selected columns
                        const selectedColumns = [];
                        $('#columnCheckboxes input:checked').each(function() {
                            selectedColumns.push(parseInt($(this).val(), 10));
                        });
                        
                        // Create export options
                        const exportOptions = {
                            columns: selectedColumns,
                            modifier: {
                                search: allPages ? 'applied' : '',
                                page: allPages ? 'all' : 'current'
                            }
                        };
                        
                        console.log("Export type:", exportType);
                        console.log("Export options:", exportOptions);
                        
                        // Check if export libraries are loaded for PDF
                        if (exportType === 'pdf' && (typeof pdfMake === 'undefined' || typeof JSZip !== 'function')) {
                            console.warn("PDF libraries not loaded, using direct download link");
                            window.location.href = "{% url 'export_filtered_students_pdf' %}";
                            $('#exportOptionsModal').modal('hide');
                            return;
                        }
                        
                        // Execute the export
                        if (exportType === 'excel') {
                            table.button('.buttons-excel').trigger({
                                exportOptions: exportOptions,
                                filename: filename
                            });
                        } else if (exportType === 'pdf') {
                            // Add some extra debug info
                            console.log("PDF export started");
                            console.log("pdfMake available:", typeof pdfMake !== 'undefined');
                            console.log("JSZip available:", typeof JSZip === 'function');
                            
                            try {
                                table.button('.buttons-pdf').trigger({
                                    exportOptions: exportOptions,
                                    filename: filename
                                });
                            } catch (err) {
                                console.error("PDF export error:", err);
                                alert("There was an error generating the PDF. Using alternative download method.");
                                window.location.href = "{% url 'export_filtered_students_pdf' %}";
                            }
                        } else if (exportType === 'csv') {
                            table.button('.buttons-csv').trigger({
                                exportOptions: exportOptions,
                                filename: filename
                            });
                        } else if (exportType === 'print') {
                            table.button('.buttons-print').trigger({
                                exportOptions: exportOptions
                            });
                        }
                        
                        // Close the modal
                        $('#exportOptionsModal').modal('hide');
                    } catch (err) {
                        console.error("Export error:", err);
                        alert("Export failed. Please try using the direct download links at the bottom of the export options.");
                    }
                });
            
                // Handle filter form submission with debouncing
                let filterTimeout;
                $('#filterForm').on('submit', function (e) {
                    e.preventDefault();
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle filter input changes with debouncing
                $('#filterForm input, #filterForm select').on('change keyup', function () {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(function () {
                        updateActiveFilters();
                        table.ajax.reload();
                    }, 300);
                });

                // Handle reset button
                $('#resetFilters').on('click', function () {
                    $('#filterForm')[0].reset();
                    updateActiveFilters();
                    table.ajax.reload();
                });

                // Update active filters display
                function updateActiveFilters() {
                    const activeFilters = $('#activeFilters');
                    activeFilters.empty();

                    const filters = {
                        'ID': $('#id').val(),
                        'Name': $('#name').val(),
                        'Email': $('#email').val(),
                        'Phone': $('#phone').val(),
                        'Course': $('#course').val(),
                        'Year': $('#year').val(),
                        'CGPA': $('#cgpa').val() ? $('#cgpa_operator').val() + ' ' + $('#cgpa').val() : '',
                        'Status': $('#status').val(),
                        'Companies Left': $('#companies_left').val() ? $('#companies_operator').val() + ' ' + $('#companies_left').val() : '',
                        'Profile Score': $('#profile_score').val() ? $('#score_operator').val() + ' ' + $('#profile_score').val() : ''
                    };

                    for (const [key, value] of Object.entries(filters)) {
                        if (value) {
                            const badge = $('<span>')
                                .addClass('badge bg-primary filter-badge')
                                .text(`${key}: ${value}`);
                            activeFilters.append(badge);
                        }
                    }
                }
                
                // Function to initialize export options modal
                function initExportOptionsModal(table) {
                    const columnContainer = $('#columnCheckboxes');
                    
                    // Clear existing content
                    columnContainer.empty();
                    
                    // Add checkbox for each exportable column
                    table.columns().every(function(index) {
                        if (index < table.columns().count() - 1) { // Skip the actions column
                            const columnTitle = $(table.column(index).header()).text();
                            const columnCheckbox = $(`
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="${index}" id="column${index}" checked>
                                        <label class="form-check-label" for="column${index}">
                                            ${columnTitle}
                                        </label>
                                    </div>
                                </div>
                            `);
                            columnContainer.append(columnCheckbox);
                        }
                    });
                }
                
                // Function to show export options modal
                function showExportOptions(exportType) {
                    // Set the export type on the proceed button
                    $('#proceedExport').data('exportType', exportType);
                    
                    // Set modal title based on export type
                    let modalTitle = 'Export Options';
                    switch(exportType) {
                        case 'excel':
                            modalTitle = 'Export to Excel';
                            break;
                        case 'pdf':
                            modalTitle = 'Export to PDF';
                            break;
                        case 'csv':
                            modalTitle = 'Export to CSV';
                            break;
                        case 'print':
                            modalTitle = 'Print Data';
                            break;
                    }
                    
                    $('#exportOptionsModalLabel').text(modalTitle);
                    
                    // Add file extension to filename field
                    let fileExtension = '';
                    switch(exportType) {
                        case 'excel':
                            fileExtension = '.xlsx';
                            break;
                        case 'pdf':
                            fileExtension = '.pdf';
                            break;
                        case 'csv':
                            fileExtension = '.csv';
                            break;
                    }
                    
                    const baseFilename = 'students_data';
                    $('#exportFilename').val(baseFilename + fileExtension);
                    
                    // Show the modal
                    $('#exportOptionsModal').modal('show');
                }

                // Initialize active filters
                updateActiveFilters();
            }
        } catch (error) {
            console.error('Error initializing DataTable:', error);
            alert('An error occurred while initializing the page. Please refresh or contact support.');
        }
    }

    // Make sure jQuery and all libraries are loaded before initializing
    if (typeof jQuery === 'undefined') {
        window.addEventListener('load', function() {
            setTimeout(initPage, 500);
        });
    } else {
        $(document).ready(function() {
            // Add a small delay to ensure all libraries are fully loaded
            setTimeout(initPage, 200);
        });
    }
</script>

<script>
$(document).ready(function() {
    // Function to get current filter parameters
    function getCurrentFilters() {
        return {
            id: $('#id').val() || '',
            name: $('#name').val() || '',
            email: $('#email').val() || '',
            phone: $('#phone').val() || '',
            course: $('#course').val() || '',
            year: $('#year').val() || '',
            cgpa: $('#cgpa').val() || '',
            cgpa_operator: $('#cgpa_operator').val() || '=',
            status: $('#status').val() || '',
            companies_left: $('#companies_left').val() || '',
            companies_operator: $('#companies_operator').val() || '=',
            profile_score: $('#profile_score').val() || '',
            score_operator: $('#score_operator').val() || '='
        };
    }

    // Function to create export URL with filter parameters
    function createExportUrl(format) {
        const filters = getCurrentFilters();
        let url = '/administration/export_filtered_students?format=' + format;
        
        // Add filter parameters to URL
        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                url += '&' + key + '=' + encodeURIComponent(filters[key]);
            }
        });
        
        console.log("Export URL:", url);
        return url;
    }

    // Improved export function with loading indicators and iframe download approach
    function exportWithFormat(format) {
        $('#loadingOverlay').css('display', 'flex');
        
        try {
            // Create temporary iframe for download (better browser compatibility)
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Set iframe source to our export URL
            iframe.src = createExportUrl(format);
            
            // Set a timeout to remove the iframe and hide loading overlay
            setTimeout(() => {
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
                $('#loadingOverlay').hide();
            }, 3000); // Give it 3 seconds for the download to start
        } catch (e) {
            console.error("Export error:", e);
            $('#loadingOverlay').hide();
            alert("Export failed: " + e.message + ". Please try the direct export method at the bottom of the page.");
        }
    }

    // Direct server-side export functions 
    $('#directExportCSV, #exportCSV, #filteredExportCSV').on('click', function(e) {
        e.preventDefault();
        exportWithFormat('csv');
    });
    
    $('#directExportPDF, #exportPDF, #filteredExportPDF').on('click', function(e) {
        e.preventDefault();
        // Using HTML for PDF export is more reliable
        exportWithFormat('html');
    });
    
    $('#exportExcel, #filteredExportExcel').on('click', function(e) {
        e.preventDefault();
        exportWithFormat('csv'); // Excel can import CSV files
    });
    
    $('#filteredExportHTML').on('click', function(e) {
        e.preventDefault();
        exportWithFormat('html');
    });

    // Fetch-based export as a fallback approach
    $('#fetchExportCSV').on('click', function(e) {
        e.preventDefault();
        $('#loadingOverlay').css('display', 'flex');
        
        fetch(createExportUrl('csv'))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'filtered_students.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                $('#loadingOverlay').hide();
            })
            .catch(error => {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
                $('#loadingOverlay').hide();
            });
    });
    
    $('#fetchExportHTML').on('click', function(e) {
        e.preventDefault();
        $('#loadingOverlay').css('display', 'flex');
        
        fetch(createExportUrl('html'))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'filtered_students.html';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                $('#loadingOverlay').hide();
            })
            .catch(error => {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
                $('#loadingOverlay').hide();
            });
    });
});
</script>

<script>
    // Function to sync main filters to direct form
    function syncMainFiltersToDirectForm() {
        if ($('#syncFilters').prop('checked')) {
            const directForm = $('form[action="/administration/export_filtered_students"]');
            
            // Clear any existing hidden fields
            directForm.find('input[type="hidden"]:not([name="format"])').remove();
            
            // Add all filter values as hidden fields
            $('#filterForm input, #filterForm select').each(function() {
                const input = $(this);
                const name = input.attr('name');
                const value = input.val();
                
                if (name && value) {
                    directForm.append(`<input type="hidden" name="${name}" value="${value}">`);
                }
            });
            
            // Update the display of active filters
            const filterTexts = [];
            $('#activeFilters .filter-badge').each(function() {
                filterTexts.push($(this).text());
            });
            
            $('#directFormFilters').text(filterTexts.join(', ') || 'No filters set');
        }
    }
    
    // Update filters when the sync checkbox changes
    $('#syncFilters').on('change', syncMainFiltersToDirectForm);
    
    // Update filters when the main form changes
    $('#filterForm').on('submit', syncMainFiltersToDirectForm);
    $('#filterForm input, #filterForm select').on('change keyup', function() {
        // Add debounce for performance
        clearTimeout(window.filterSyncTimeout);
        window.filterSyncTimeout = setTimeout(syncMainFiltersToDirectForm, 500);
    });
    
    // Sync filters once on page load
    $(document).ready(function() {
        setTimeout(syncMainFiltersToDirectForm, 1000);
    });
</script>

<script>
    // Function to create filtered export URL with current filters
    function createFilteredExportUrl(format) {
        // Get all filter values
        const filters = {
            id: $('#id').val() || '',
            name: $('#name').val() || '',
            email: $('#email').val() || '',
            phone: $('#phone').val() || '',
            course: $('#course').val() || '',
            year: $('#year').val() || '',
            cgpa: $('#cgpa').val() || '',
            cgpa_operator: $('#cgpa_operator').val() || '=',
            status: $('#status').val() || '',
            companies_left: $('#companies_left').val() || '',
            companies_operator: $('#companies_operator').val() || '=',
            format: format
        };
        
        // Create URL with parameters
        let url = '/administration/filtered_export?';
        Object.keys(filters).forEach(key => {
            url += `${key}=${encodeURIComponent(filters[key])}&`;
        });
        
        return url;
    }
    
    // Setup export button click handlers
    $(document).ready(function() {
        $('#filteredExportCSV').click(function(e) {
            e.preventDefault();
            window.open(createFilteredExportUrl('csv'), '_blank');
        });
        
        $('#filteredExportExcel').click(function(e) {
            e.preventDefault();
            window.open(createFilteredExportUrl('excel'), '_blank');
        });
        
        $('#filteredExportHTML').click(function(e) {
            e.preventDefault();
            window.open(createFilteredExportUrl('html'), '_blank');
        });
        
        $('#filteredExportPDF').click(function(e) {
            e.preventDefault();
            window.open(createFilteredExportUrl('pdf'), '_blank');
        });
    });
</script>
{% endblock %}